{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/自适应正则脚本/index.ts"],"sourcesContent":["// 自适应正则脚本\n// 功能：AI输出完成后，检测最后一层聊天存在的表达式，将匹配的 scriptName 存入变量并排序\n// 加载脚本/变量变化时，检查角色卡正则列表与变量列表，注册缺失的正则\n// 卸载脚本时，根据列表卸载对应的正则\n\nimport regexData from './regex.json';\n\n$(async () => {\n  console.info('自适应正则脚本已加载');\n\n  // 聊天变量键名 - 存储当前应该注册的正则 scriptName 列表\n  const VARIABLE_KEY = 'adaptive_regex_names';\n\n  // 同步锁，防止无限循环\n  let isSyncing = false;\n\n  console.info(`自适应正则: 成功加载 ${regexData.length} 条规则`);\n\n  // 从 regex.json 中获取有效的正则规则\n  const getEnabledRegexRules = (): TavernRegex[] => {\n    return regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => ({\n        id: rule.id,\n        script_name: rule.scriptName,\n        enabled: true,\n        scope: 'character' as const,\n        find_regex: rule.findRegex,\n        replace_string: rule.replaceString,\n        trim_strings: Array.isArray(rule.trimStrings) ? rule.trimStrings.join('\\n') : '',\n        source: {\n          user_input: false,\n          ai_output: true,\n          slash_command: false,\n          world_info: false,\n        },\n        destination: {\n          display: true,\n          prompt: false,\n        },\n        run_on_edit: rule.runOnEdit ?? true,\n        min_depth: rule.minDepth ?? null,\n        max_depth: rule.maxDepth ?? 10,\n      }));\n  };\n\n  // 从 regex.json 提取检测模式（便于后续拓展）\n  const extractDetectionPatterns = (): { scriptName: string; pattern: RegExp; quickCheck: string }[] => {\n    return regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => {\n        let patternStr = rule.findRegex;\n\n        // 解析正则表达式，去除可能的 /pattern/flags 格式\n        const match = patternStr.match(/^\\/(.+)\\/([gimsuy]*)$/);\n        if (match) {\n          patternStr = match[1];\n        }\n\n        try {\n          const pattern = new RegExp(patternStr, 'i');\n\n          let quickCheck = '';\n          if (patternStr.includes('{') || patternStr.includes('\\\\{')) {\n            quickCheck = '{';\n          } else if (patternStr.includes('<') || patternStr.includes('\\\\<')) {\n            const tagMatch = patternStr.match(/<(\\w+)/);\n            if (tagMatch) {\n              quickCheck = `<${tagMatch[1]}`;\n            }\n          } else if (patternStr.includes('\\\\[') || patternStr.includes('\\\\]')) {\n            quickCheck = '[';\n          } else if (patternStr.includes('\\\\(') || patternStr.includes('\\\\)')) {\n            quickCheck = '(';\n          } else if (patternStr.startsWith('>')) {\n            quickCheck = '>';\n          } else if (patternStr.startsWith('<')) {\n            const firstTagMatch = patternStr.match(/<(\\w+)/);\n            if (firstTagMatch) {\n              quickCheck = `<${firstTagMatch[1]}`;\n            }\n          } else {\n            quickCheck = patternStr.substring(0, Math.min(15, patternStr.length));\n          }\n\n          return {\n            scriptName: rule.scriptName,\n            pattern,\n            quickCheck,\n          };\n        } catch (e) {\n          console.warn(`无效的正则表达式: ${patternStr}`, e);\n          return null;\n        }\n      })\n      .filter(Boolean) as { scriptName: string; pattern: RegExp; quickCheck: string }[];\n  };\n\n  // 检测消息中包含的需要处理的正则 scriptName\n  // skipStoredNames: 已存储的正则名称列表，跳过这些正则的匹配检测\n  const detectNeededScriptNames = (messageContent: string, skipStoredNames: string[] = []): string[] => {\n    if (!messageContent || messageContent.length < 3) {\n      return [];\n    }\n\n    const patterns = extractDetectionPatterns();\n    const neededNames: string[] = [];\n    const skipSet = new Set(skipStoredNames);\n\n    for (const { scriptName, pattern, quickCheck } of patterns) {\n      // 跳过已存储的正则（它们已经匹配过了，不需要再次检测）\n      if (skipSet.has(scriptName)) {\n        continue;\n      }\n\n      // 快速预检查\n      if (quickCheck && !messageContent.includes(quickCheck)) {\n        continue;\n      }\n\n      try {\n        pattern.lastIndex = 0;\n        if (pattern.test(messageContent)) {\n          neededNames.push(scriptName);\n          console.info(`自适应正则: 检测到 ${scriptName}`);\n        }\n      } catch (e) {\n        // 忽略正则测试错误\n      }\n    }\n\n    return neededNames;\n  };\n\n  // 获取聊天变量中存储的正则名称列表\n  const getStoredRegexNames = (): string[] => {\n    try {\n      const chatVars = getVariables({ type: 'chat' });\n      const stored = chatVars?.[VARIABLE_KEY];\n      if (Array.isArray(stored)) {\n        return stored.filter((item): item is string => typeof item === 'string');\n      }\n    } catch (e) {\n      console.warn('获取存储的正则名称失败:', e);\n    }\n    return [];\n  };\n\n  // 保存正则名称列表到聊天变量（排序后）\n  const saveStoredRegexNames = (names: string[]): void => {\n    try {\n      // 排序保证一致性\n      const sortedNames = [...names].sort();\n      replaceVariables({ [VARIABLE_KEY]: sortedNames }, { type: 'chat' });\n      console.info(`自适应正则: 已保存 ${sortedNames.length} 个正则名称到聊天变量`);\n    } catch (e) {\n      console.warn('保存正则名称失败:', e);\n    }\n  };\n\n  // 获取角色卡当前已注册的所有正则 scriptName\n  const getCharacterCardRegexNames = async (): Promise<Set<string>> => {\n    const names = new Set<string>();\n    try {\n      const regexes = await updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        regexes.forEach(r => names.add(r.script_name));\n        return regexes;\n      });\n    } catch (e) {\n      console.warn('获取角色卡正则列表失败:', e);\n    }\n    return names;\n  };\n\n  // 注册单个正则规则\n  const registerRegexRule = async (rule: TavernRegex): Promise<void> => {\n    try {\n      await updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        // 避免重复注册同名正则\n        const filtered = regexes.filter((r: TavernRegex) => r.script_name !== rule.script_name);\n        return [...filtered, rule];\n      });\n    } catch (e) {\n      console.warn(`注册正则失败: ${rule.script_name}`, e);\n    }\n  };\n\n  // 同步正则列表：对比变量列表和角色卡正则列表\n  // - 移除：存在于角色卡正则列表但不在变量列表中的正则\n  // - 注册：存在于变量列表但不在角色卡正则列表中的正则\n  const syncRegexWithVariable = async (): Promise<void> => {\n    // 防止重复调用\n    if (isSyncing) {\n      console.info('自适应正则: 正在同步中，跳过本次调用');\n      return;\n    }\n\n    try {\n      isSyncing = true;\n\n      const variableNames = getStoredRegexNames();\n      const variableSet = new Set(variableNames);\n      const characterCardNames = await getCharacterCardRegexNames();\n      const characterSet = new Set(characterCardNames);\n\n      // 找出需要移除的正则（在角色卡中但不在变量中）\n      const toRemove: string[] = [];\n      for (const name of characterCardNames) {\n        if (!variableSet.has(name)) {\n          toRemove.push(name);\n        }\n      }\n\n      // 找出需要注册的正则（在变量中但不在角色卡中）\n      const toRegister: string[] = [];\n      for (const name of variableNames) {\n        if (!characterSet.has(name)) {\n          toRegister.push(name);\n        }\n      }\n\n      // 执行移除\n      if (toRemove.length > 0) {\n        await removeRegexByNames(toRemove);\n        console.info(`自适应正则: 已移除 ${toRemove.length} 条不在变量列表中的规则: ${toRemove.join(', ')}`);\n      }\n\n      // 执行注册\n      if (toRegister.length > 0) {\n        const allRules = getEnabledRegexRules();\n        let registeredCount = 0;\n        for (const name of toRegister) {\n          const rule = allRules.find(r => r.script_name === name);\n          if (rule) {\n            await registerRegexRule(rule);\n            registeredCount++;\n            console.info(`自适应正则: 已注册 ${name}`);\n          }\n        }\n        if (registeredCount > 0) {\n          console.info(`自适应正则: 共注册了 ${registeredCount} 条规则`);\n        }\n      }\n\n      if (toRemove.length === 0 && toRegister.length === 0) {\n        console.info('自适应正则: 变量列表与角色卡正则列表已同步，无需更新');\n      }\n    } catch (e) {\n      console.error('同步正则列表失败:', e);\n    } finally {\n      isSyncing = false;\n    }\n  };\n\n  // 移除指定名称的正则\n  const removeRegexByNames = async (names: string[]): Promise<void> => {\n    if (names.length === 0) return;\n\n    try {\n      await updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        return regexes.filter((r: TavernRegex) => !names.includes(r.script_name));\n      });\n      console.info(`自适应正则: 已移除 ${names.length} 条规则`);\n    } catch (e) {\n      console.warn('移除正则失败:', e);\n    }\n  };\n\n  // 扫描最后一层消息并更新变量\n  const scanAndUpdateVariable = async (): Promise<void> => {\n    try {\n      console.info('自适应正则: 开始扫描最后一层消息');\n\n      const messages = getChatMessages(-1); // 获取最后一条消息\n      console.info('自适应正则: 获取到的消息:', messages);\n\n      if (!messages || messages.length === 0) {\n        console.info('自适应正则: 没有找到消息，返回');\n        return;\n      }\n\n      const lastMessage = messages[0];\n      const messageContent = lastMessage.message;\n      console.info('自适应正则: 消息内容:', messageContent);\n\n      // 获取已存储的名称，用于跳过检测\n      const storedNames = getStoredRegexNames();\n      console.info('自适应正则: 已存储的正则名称:', storedNames);\n\n      // 检测需要的正则名称（跳过已存储的正则）\n      const detectedNames = detectNeededScriptNames(messageContent, storedNames);\n      console.info('自适应正则: 检测到的新正则名称:', detectedNames);\n\n      // 合并并去重\n      const combinedNames = [...new Set([...storedNames, ...detectedNames])];\n      console.info('自适应正则: 合并后的正则名称:', combinedNames);\n\n      // 如果有变化，保存并同步\n      const storedSorted = [...storedNames].sort().join(',');\n      const combinedSorted = [...combinedNames].sort().join(',');\n      console.info('自适应正则: 排序后的存储名称:', storedSorted);\n      console.info('自适应正则: 排序后的合并名称:', combinedSorted);\n\n      if (storedSorted !== combinedSorted) {\n        console.info(`自适应正则: 检测到变化，从 ${storedNames.length} 个更新到 ${combinedNames.length} 个`);\n        saveStoredRegexNames(combinedNames);\n        await syncRegexWithVariable();\n      } else {\n        console.info('自适应正则: 无变化，不更新');\n      }\n    } catch (e) {\n      console.error('扫描消息更新变量失败:', e);\n    }\n  };\n\n  // 初始化：根据变量中的列表注册缺失的正则\n  const initializeFromVariable = async (): Promise<void> => {\n    const storedNames = getStoredRegexNames();\n    if (storedNames.length > 0) {\n      console.info(`自适应正则: 初始化，从变量加载 ${storedNames.length} 个正则`);\n      await syncRegexWithVariable();\n    } else {\n      // 如果变量为空，扫描当前消息\n      console.info('自适应正则: 变量为空，扫描当前消息');\n      await scanAndUpdateVariable();\n    }\n  };\n\n  // 监听变量变化的事件回调\n  let previousStoredNames: string[] = [];\n\n  const watchVariableChange = (): void => {\n    // 初始记录\n    previousStoredNames = getStoredRegexNames();\n\n    // 重写 replaceVariables 函数来监听变量变化\n    const originalReplaceVariables = replaceVariables;\n    (window as any).replaceVariables = function (variables: Record<string, any>, option: any) {\n      const result = originalReplaceVariables.call(this, variables, option);\n\n      // 检查是否是聊天变量发生变化，且不在同步中\n      if (!isSyncing && (option?.type === 'chat' || !option)) {\n        const currentStoredNames = getStoredRegexNames();\n        const currentSorted = [...currentStoredNames].sort().join(',');\n        const previousSorted = [...previousStoredNames].sort().join(',');\n\n        if (currentSorted !== previousSorted) {\n          console.info(`自适应正则: 变量发生变化，刷新正则列表`);\n          syncRegexWithVariable().then(() => {\n            previousStoredNames = currentStoredNames;\n          });\n        }\n      }\n\n      return result;\n    };\n  };\n\n  // 监听新消息事件（AI输出完成时）\n  eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {\n    console.info(`自适应正则: 收到新消息 ${messageId}，扫描最新楼层`);\n    await scanAndUpdateVariable();\n  });\n\n  // 监听聊天切换事件\n  eventOn(tavern_events.CHAT_CHANGED, async (chatFileName: string) => {\n    console.info(`自适应正则: 切换聊天 ${chatFileName}，同步变量列表与正则列表`);\n    // 切换聊天时，对比变量列表和角色卡正则列表进行同步\n    await syncRegexWithVariable();\n  });\n\n  // 卸载时移除所有本脚本注册的正则\n  $(window).on('pagehide', async () => {\n    const storedNames = getStoredRegexNames();\n    if (storedNames.length > 0) {\n      await removeRegexByNames(storedNames);\n      console.info(`自适应正则: 已卸载 ${storedNames.length} 条规则`);\n    }\n    console.info('自适应正则脚本已卸载');\n  });\n\n  // 启动\n  console.info('自适应正则: 启动初始化');\n  await initializeFromVariable();\n  watchVariableChange();\n\n  const enabledRules = regexData.filter((r: any) => !r.disabled).length;\n  console.info(`自适应正则: 准备了 ${enabledRules} 条规则用于检测`);\n});\n"],"names":["$","async","console","info","VARIABLE_KEY","isSyncing","length","detectNeededScriptNames","messageContent","skipStoredNames","patterns","filter","rule","disabled","map","patternStr","findRegex","match","pattern","RegExp","quickCheck","includes","tagMatch","startsWith","firstTagMatch","substring","Math","min","scriptName","e","warn","Boolean","neededNames","skipSet","Set","has","lastIndex","test","push","getStoredRegexNames","chatVars","getVariables","type","stored","Array","isArray","item","registerRegexRule","updateTavernRegexesWith","regexes","r","script_name","syncRegexWithVariable","variableNames","variableSet","characterCardNames","names","forEach","add","getCharacterCardRegexNames","characterSet","toRemove","name","toRegister","removeRegexByNames","join","allRules","id","enabled","scope","find_regex","replace_string","replaceString","trim_strings","trimStrings","source","user_input","ai_output","slash_command","world_info","destination","display","prompt","run_on_edit","runOnEdit","min_depth","minDepth","max_depth","maxDepth","registeredCount","find","error","scanAndUpdateVariable","messages","getChatMessages","message","storedNames","detectedNames","combinedNames","storedSorted","sort","combinedSorted","sortedNames","replaceVariables","saveStoredRegexNames","previousStoredNames","eventOn","tavern_events","MESSAGE_RECEIVED","messageId","CHAT_CHANGED","chatFileName","window","on","initializeFromVariable","originalReplaceVariables","variables","option","result","call","this","currentStoredNames","then","watchVariableChange","enabledRules"],"sourceRoot":""}