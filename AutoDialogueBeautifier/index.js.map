{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/自适应正则脚本/index.ts"],"sourcesContent":["// 自适应正则脚本\n// 功能：AI输出完成后，检测最后一层聊天存在的表达式，将匹配的 scriptName 存入变量并排序\n// 加载脚本/变量变化时，检查角色卡正则列表与变量列表，注册缺失的正则\n// 卸载脚本时，根据列表卸载对应的正则\n\nimport regexData from './regex.json';\n\n$(async () => {\n  console.info('自适应正则脚本已加载');\n\n  // 聊天变量键名 - 存储当前应该注册的正则 scriptName 列表\n  const VARIABLE_KEY = 'adaptive_regex_names';\n\n  console.info(`自适应正则: 成功加载 ${regexData.length} 条规则`);\n\n  // 从 regex.json 中获取有效的正则规则\n  const getEnabledRegexRules = (): TavernRegex[] => {\n    return regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => ({\n        id: rule.id,\n        script_name: rule.scriptName,\n        enabled: true,\n        scope: 'character' as const,\n        find_regex: rule.findRegex,\n        replace_string: rule.replaceString,\n        trim_strings: Array.isArray(rule.trimStrings) ? rule.trimStrings.join('\\n') : '',\n        source: {\n          user_input: false,\n          ai_output: true,\n          slash_command: false,\n          world_info: false,\n        },\n        destination: {\n          display: true,\n          prompt: false,\n        },\n        run_on_edit: rule.runOnEdit ?? true,\n        min_depth: rule.minDepth ?? null,\n        max_depth: rule.maxDepth ?? 10,\n      }));\n  };\n\n  // 从 regex.json 提取检测模式（便于后续拓展）\n  const extractDetectionPatterns = (): { scriptName: string; pattern: RegExp; quickCheck: string }[] => {\n    return regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => {\n        let patternStr = rule.findRegex;\n\n        // 解析正则表达式，去除可能的 /pattern/flags 格式\n        const match = patternStr.match(/^\\/(.+)\\/([gimsuy]*)$/);\n        if (match) {\n          patternStr = match[1];\n        }\n\n        try {\n          const pattern = new RegExp(patternStr, 'i');\n\n          let quickCheck = '';\n          if (patternStr.includes('{') || patternStr.includes('\\\\{')) {\n            quickCheck = '{';\n          } else if (patternStr.includes('<') || patternStr.includes('\\\\<')) {\n            const tagMatch = patternStr.match(/<(\\w+)/);\n            if (tagMatch) {\n              quickCheck = `<${tagMatch[1]}`;\n            }\n          } else if (patternStr.includes('\\\\[') || patternStr.includes('\\\\]')) {\n            quickCheck = '[';\n          } else if (patternStr.includes('\\\\(') || patternStr.includes('\\\\)')) {\n            quickCheck = '(';\n          } else if (patternStr.startsWith('>')) {\n            quickCheck = '>';\n          } else if (patternStr.startsWith('<')) {\n            const firstTagMatch = patternStr.match(/<(\\w+)/);\n            if (firstTagMatch) {\n              quickCheck = `<${firstTagMatch[1]}`;\n            }\n          } else {\n            quickCheck = patternStr.substring(0, Math.min(15, patternStr.length));\n          }\n\n          return {\n            scriptName: rule.scriptName,\n            pattern,\n            quickCheck,\n          };\n        } catch (e) {\n          console.warn(`无效的正则表达式: ${patternStr}`, e);\n          return null;\n        }\n      })\n      .filter(Boolean) as { scriptName: string; pattern: RegExp; quickCheck: string }[];\n  };\n\n  // 检测消息中包含的需要处理的正则 scriptName\n  const detectNeededScriptNames = (messageContent: string): string[] => {\n    if (!messageContent || messageContent.length < 3) {\n      return [];\n    }\n\n    const patterns = extractDetectionPatterns();\n    const neededNames: string[] = [];\n\n    for (const { scriptName, pattern, quickCheck } of patterns) {\n      // 快速预检查\n      if (quickCheck && !messageContent.includes(quickCheck)) {\n        continue;\n      }\n\n      try {\n        pattern.lastIndex = 0;\n        if (pattern.test(messageContent)) {\n          neededNames.push(scriptName);\n          console.info(`自适应正则: 检测到 ${scriptName}`);\n        }\n      } catch (e) {\n        // 忽略正则测试错误\n      }\n    }\n\n    return neededNames;\n  };\n\n  // 获取聊天变量中存储的正则名称列表\n  const getStoredRegexNames = (): string[] => {\n    try {\n      const chatVars = getVariables({ type: 'chat' });\n      const stored = chatVars?.[VARIABLE_KEY];\n      if (Array.isArray(stored)) {\n        return stored.filter((item): item is string => typeof item === 'string');\n      }\n    } catch (e) {\n      console.warn('获取存储的正则名称失败:', e);\n    }\n    return [];\n  };\n\n  // 保存正则名称列表到聊天变量（排序后）\n  const saveStoredRegexNames = (names: string[]): void => {\n    try {\n      // 排序保证一致性\n      const sortedNames = [...names].sort();\n      replaceVariables({ [VARIABLE_KEY]: sortedNames }, { type: 'chat' });\n      console.info(`自适应正则: 已保存 ${sortedNames.length} 个正则名称到聊天变量`);\n    } catch (e) {\n      console.warn('保存正则名称失败:', e);\n    }\n  };\n\n  // 获取角色卡当前已注册的所有正则 scriptName\n  const getCharacterCardRegexNames = async (): Promise<Set<string>> => {\n    const names = new Set<string>();\n    try {\n      const regexes = await updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        regexes.forEach(r => names.add(r.script_name));\n        return regexes;\n      });\n    } catch (e) {\n      console.warn('获取角色卡正则列表失败:', e);\n    }\n    return names;\n  };\n\n  // 注册单个正则规则\n  const registerRegexRule = async (rule: TavernRegex): Promise<void> => {\n    try {\n      await updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        // 避免重复注册同名正则\n        const filtered = regexes.filter((r: TavernRegex) => r.script_name !== rule.script_name);\n        return [...filtered, rule];\n      });\n    } catch (e) {\n      console.warn(`注册正则失败: ${rule.script_name}`, e);\n    }\n  };\n\n  // 批量注册缺失的正则\n  const registerMissingRegexes = async (targetNames: string[]): Promise<void> => {\n    const allRules = getEnabledRegexRules();\n    const characterCardNames = await getCharacterCardRegexNames();\n    let registeredCount = 0;\n\n    for (const name of targetNames) {\n      // 如果角色卡中已有此正则，跳过\n      if (characterCardNames.has(name)) {\n        continue;\n      }\n\n      // 查找对应的规则\n      const rule = allRules.find(r => r.script_name === name);\n      if (rule) {\n        await registerRegexRule(rule);\n        registeredCount++;\n        console.info(`自适应正则: 已注册 ${name}`);\n      }\n    }\n\n    if (registeredCount > 0) {\n      console.info(`自适应正则: 共注册了 ${registeredCount} 条规则`);\n    }\n  };\n\n  // 移除指定名称的正则\n  const removeRegexByNames = async (names: string[]): Promise<void> => {\n    if (names.length === 0) return;\n\n    try {\n      await updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        return regexes.filter((r: TavernRegex) => !names.includes(r.script_name));\n      });\n      console.info(`自适应正则: 已移除 ${names.length} 条规则`);\n    } catch (e) {\n      console.warn('移除正则失败:', e);\n    }\n  };\n\n  // 扫描最后一层消息并更新变量\n  const scanAndUpdateVariable = async (): Promise<void> => {\n    try {\n      console.info('自适应正则: 开始扫描最后一层消息');\n\n      const messages = getChatMessages(-1); // 获取最后一条消息\n      console.info('自适应正则: 获取到的消息:', messages);\n\n      if (!messages || messages.length === 0) {\n        console.info('自适应正则: 没有找到消息，返回');\n        return;\n      }\n\n      const lastMessage = messages[0];\n      const messageContent = lastMessage.message;\n      console.info('自适应正则: 消息内容:', messageContent);\n\n      // 检测需要的正则名称\n      const detectedNames = detectNeededScriptNames(messageContent);\n      console.info('自适应正则: 检测到的正则名称:', detectedNames);\n\n      // 获取已存储的名称\n      const storedNames = getStoredRegexNames();\n      console.info('自适应正则: 已存储的正则名称:', storedNames);\n\n      // 合并并去重\n      const combinedNames = [...new Set([...storedNames, ...detectedNames])];\n      console.info('自适应正则: 合并后的正则名称:', combinedNames);\n\n      // 如果有变化，保存并注册\n      const storedSorted = [...storedNames].sort().join(',');\n      const combinedSorted = [...combinedNames].sort().join(',');\n      console.info('自适应正则: 排序后的存储名称:', storedSorted);\n      console.info('自适应正则: 排序后的合并名称:', combinedSorted);\n\n      if (storedSorted !== combinedSorted) {\n        console.info(`自适应正则: 检测到变化，从 ${storedNames.length} 个更新到 ${combinedNames.length} 个`);\n        saveStoredRegexNames(combinedNames);\n        await registerMissingRegexes(combinedNames);\n      } else {\n        console.info('自适应正则: 无变化，不更新');\n      }\n    } catch (e) {\n      console.error('扫描消息更新变量失败:', e);\n    }\n  };\n\n  // 初始化：根据变量中的列表注册缺失的正则\n  const initializeFromVariable = async (): Promise<void> => {\n    const storedNames = getStoredRegexNames();\n    if (storedNames.length > 0) {\n      console.info(`自适应正则: 初始化，从变量加载 ${storedNames.length} 个正则`);\n      await registerMissingRegexes(storedNames);\n    } else {\n      // 如果变量为空，扫描当前消息\n      console.info('自适应正则: 变量为空，扫描当前消息');\n      await scanAndUpdateVariable();\n    }\n  };\n\n  // 监听变量变化的事件回调\n  let previousStoredNames: string[] = [];\n\n  const watchVariableChange = (): void => {\n    // 初始记录\n    previousStoredNames = getStoredRegexNames();\n\n    // 重写 replaceVariables 函数来监听变量变化\n    const originalReplaceVariables = replaceVariables;\n    (window as any).replaceVariables = function (variables: Record<string, any>, option: any) {\n      const result = originalReplaceVariables.call(this, variables, option);\n\n      // 检查是否是聊天变量发生变化\n      if (option?.type === 'chat' || !option) {\n        const currentStoredNames = getStoredRegexNames();\n        const currentSorted = [...currentStoredNames].sort().join(',');\n        const previousSorted = [...previousStoredNames].sort().join(',');\n\n        if (currentSorted !== previousSorted) {\n          console.info(`自适应正则: 变量发生变化，刷新正则列表`);\n          registerMissingRegexes(currentStoredNames).then(() => {\n            previousStoredNames = currentStoredNames;\n          });\n        }\n      }\n\n      return result;\n    };\n  };\n\n  // 监听新消息事件（AI输出完成时）\n  eventOn(tavern_events.MESSAGE_RECEIVED, async (messageId: number) => {\n    console.info(`自适应正则: 收到新消息 ${messageId}，扫描最新楼层`);\n    await scanAndUpdateVariable();\n  });\n\n  // 卸载时移除所有本脚本注册的正则\n  $(window).on('pagehide', async () => {\n    const storedNames = getStoredRegexNames();\n    if (storedNames.length > 0) {\n      await removeRegexByNames(storedNames);\n      console.info(`自适应正则: 已卸载 ${storedNames.length} 条规则`);\n    }\n    console.info('自适应正则脚本已卸载');\n  });\n\n  // 启动\n  console.info('自适应正则: 启动初始化');\n  await initializeFromVariable();\n  watchVariableChange();\n\n  const enabledRules = regexData.filter((r: any) => !r.disabled).length;\n  console.info(`自适应正则: 准备了 ${enabledRules} 条规则用于检测`);\n});\n"],"names":["$","async","console","info","VARIABLE_KEY","length","detectNeededScriptNames","messageContent","patterns","filter","rule","disabled","map","patternStr","findRegex","match","pattern","RegExp","quickCheck","includes","tagMatch","startsWith","firstTagMatch","substring","Math","min","scriptName","e","warn","Boolean","neededNames","lastIndex","test","push","getStoredRegexNames","chatVars","getVariables","type","stored","Array","isArray","item","registerRegexRule","updateTavernRegexesWith","regexes","r","script_name","registerMissingRegexes","targetNames","allRules","id","enabled","scope","find_regex","replace_string","replaceString","trim_strings","trimStrings","join","source","user_input","ai_output","slash_command","world_info","destination","display","prompt","run_on_edit","runOnEdit","min_depth","minDepth","max_depth","maxDepth","characterCardNames","names","Set","forEach","add","getCharacterCardRegexNames","registeredCount","name","has","find","scanAndUpdateVariable","messages","getChatMessages","message","detectedNames","storedNames","combinedNames","storedSorted","sort","combinedSorted","sortedNames","replaceVariables","saveStoredRegexNames","error","previousStoredNames","eventOn","tavern_events","MESSAGE_RECEIVED","messageId","window","on","removeRegexByNames","initializeFromVariable","originalReplaceVariables","variables","option","result","call","this","currentStoredNames","then","watchVariableChange","enabledRules"],"sourceRoot":""}