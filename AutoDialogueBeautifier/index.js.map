{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/自适应正则脚本/index.ts"],"sourcesContent":["// 自适应正则脚本\n// 功能：检测AI输出聊天中存在表达式内容时，自动注册相应的正则规则\n// 卸载时自动移除所有其注册的正则\n// 性能优化：缓存检测模式、延迟执行，防抖、跳过已注册规则\n\nimport regexData from './regex.json';\n\n$(async () => {\n  console.info('自适应正则脚本已加载');\n\n  // ===== 优化1: 使用 Set 替代数组存储已注册ID (O(1) 查找) =====\n  const registeredRegexIds = new Set<string>();\n\n  // ===== 优化2: 缓存解析结果 =====\n  // 缓存提取的检测模式和预检查标记\n  let cachedPatterns: { id: string; pattern: RegExp; name: string; quickCheck: string }[] | null = null;\n  // 缓存转换后的酒馆正则规则\n  let cachedTavernRules: TavernRegex[] | null = null;\n\n  // 解析正则数据，转换为酒馆正则格式（带缓存）\n  const parseRegexRules = (): TavernRegex[] => {\n    if (cachedTavernRules) {\n      return cachedTavernRules;\n    }\n\n    cachedTavernRules = regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => ({\n        id: rule.id,\n        script_name: rule.scriptName,\n        enabled: true,\n        scope: 'character' as const,\n        find_regex: rule.findRegex,\n        replace_string: rule.replaceString,\n        trim_strings: Array.isArray(rule.trimStrings) ? rule.trimStrings.join('\\n') : '',\n        source: {\n          user_input: false,\n          ai_output: true,\n          slash_command: false,\n          world_info: false,\n        },\n        destination: {\n          display: true,\n          prompt: false,\n        },\n        run_on_edit: rule.runOnEdit ?? true,\n        min_depth: rule.minDepth ?? null,\n        max_depth: rule.maxDepth ?? 10,\n      }));\n\n    return cachedTavernRules;\n  };\n\n  // 从正则规则中提取检测模式（带缓存）\n  const extractDetectionPatterns = (): { id: string; pattern: RegExp; name: string; quickCheck: string }[] => {\n    if (cachedPatterns) {\n      return cachedPatterns;\n    }\n\n    cachedPatterns = regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => {\n        // 清理正则表达式\n        let patternStr = rule.findRegex;\n        const match = patternStr.match(/^\\/(.+)\\/([gimsuy]*)$/);\n        if (match) {\n          patternStr = match[1];\n        }\n\n        // 尝试创建正则\n        try {\n          const pattern = new RegExp(patternStr, 'i');\n\n          // ===== 优化3: 改进快速检查字符串提取 =====\n          let quickCheck = '';\n          // 优先提取正则中的特殊字符或结构化标记\n          if (patternStr.includes('{') || patternStr.includes('\\\\{')) {\n            quickCheck = '{';\n          } else if (patternStr.includes('<') || patternStr.includes('\\\\<')) {\n            const tagMatch = patternStr.match(/<(\\w+)/);\n            if (tagMatch) {\n              quickCheck = `<${tagMatch[1]}`;\n            }\n          } else if (patternStr.includes('\\\\[') || patternStr.includes('\\\\]')) {\n            quickCheck = '[';\n          } else if (patternStr.includes('\\\\(') || patternStr.includes('\\\\)')) {\n            quickCheck = '(';\n          } else if (patternStr.startsWith('>')) {\n            // 中文冒号格式\n            quickCheck = '>';\n          } else if (patternStr.startsWith('<')) {\n            // 标签格式\n            const firstTagMatch = patternStr.match(/<(\\w+)/);\n            if (firstTagMatch) {\n              quickCheck = `<${firstTagMatch[1]}`;\n            }\n          } else {\n            // 使用正则的前15个字符作为快速检查\n            quickCheck = patternStr.substring(0, Math.min(15, patternStr.length));\n          }\n\n          return {\n            id: rule.id,\n            pattern,\n            name: rule.scriptName,\n            quickCheck,\n          };\n        } catch (e) {\n          console.warn(`无效的正则表达式: ${patternStr}`, e);\n          return null;\n        }\n      })\n      .filter(Boolean) as { id: string; pattern: RegExp; name: string; quickCheck: string }[];\n\n    return cachedPatterns;\n  };\n\n  // ===== 优化10: 酒馆正则已注册名称缓存 =====\n  const existingRegexNames = new Set<string>();\n\n  // ===== 聊天变量键名 =====\n  const CHAT_VAR_KEY = '自适应正则_已注册列表';\n\n  // 从聊天变量加载已注册的正则名称\n  const loadRegisteredRegexesFromChat = (): string[] => {\n    try {\n      const chatVars = getVariables({ type: 'chat' });\n      const registered = chatVars?.[CHAT_VAR_KEY];\n      if (Array.isArray(registered)) {\n        return registered.filter((item): item is string => typeof item === 'string');\n      }\n    } catch (e) {\n      // 忽略读取错误\n    }\n    return [];\n  };\n\n  // 保存已注册的正则名称到聊天变量\n  const saveRegisteredRegexesToChat = (names: string[]) => {\n    try {\n      replaceVariables({ [CHAT_VAR_KEY]: names }, { type: 'chat' });\n    } catch (e) {\n      // 忽略保存错误\n    }\n  };\n\n  // 初始化时获取已存在的正则名称（从酒馆和聊天变量）\n  const initExistingRegexes = async () => {\n    try {\n      // 1. 获取酒馆中已存在的正则名称\n      await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        regexes.forEach(r => existingRegexNames.add(r.script_name));\n        return regexes;\n      });\n\n      // 2. 从聊天变量加载已注册的正则名称（用于跨会话保持）\n      const savedNames = loadRegisteredRegexesFromChat();\n      savedNames.forEach(name => existingRegexNames.add(name));\n      console.info(`自适应正则: 从聊天变量恢复了 ${savedNames.length} 条已注册正则`);\n    } catch (e) {\n      // 忽略初始化错误\n    }\n  };\n\n  // 检测消息中是否包含需要处理的表达式（带快速预检查）\n  const detectNeededRegexes = (messageContent: string): string[] => {\n    // 消息长度预检\n    if (!messageContent || messageContent.length < 3) {\n      return [];\n    }\n\n    const patterns = extractDetectionPatterns();\n    const neededIds: string[] = [];\n\n    for (const { id, pattern, name, quickCheck } of patterns) {\n      // 优化5: 使用 Set 的 has 方法 O(1) 查找 - 跳过内存中已注册的正则\n      if (registeredRegexIds.has(id)) {\n        continue;\n      }\n\n      // 优化10: 跳过酒馆中已存在的同名正则（可能有其他脚本注册）\n      if (existingRegexNames.has(name)) {\n        registeredRegexIds.add(id); // 标记为已处理，避免重复检测\n        continue;\n      }\n\n      // 快速预检查\n      if (quickCheck && !messageContent.includes(quickCheck)) {\n        continue;\n      }\n\n      try {\n        pattern.lastIndex = 0;\n        if (pattern.test(messageContent)) {\n          neededIds.push(id);\n          console.info(`自适应正则: 检测到 ${name}，准备注册`);\n        }\n      } catch (e) {\n        // 忽略正则测试错误\n      }\n    }\n\n    return neededIds;\n  };\n\n  // ===== 优化7: 批量处理函数 =====\n  let debounceTimer: ReturnType<typeof setTimeout> | null = null;\n  const pendingMessageIds = new Set<number>();\n\n  const processMessageQueue = async () => {\n    if (pendingMessageIds.size === 0) return;\n\n    const messageIds = Array.from(pendingMessageIds);\n    pendingMessageIds.clear();\n\n    // 收集所有待注册的正则ID\n    const allNeededIds = new Set<string>();\n\n    for (const message_id of messageIds) {\n      try {\n        // ===== 优化8: 直接获取消息内容而非遍历 =====\n        const messages = getChatMessages(message_id);\n        if (!messages || messages.length === 0) continue;\n\n        const messageContent = messages[0].message;\n        const neededIds = detectNeededRegexes(messageContent);\n        neededIds.forEach(id => allNeededIds.add(id));\n      } catch (error) {\n        console.error('自适应正则处理出错:', error);\n      }\n    }\n\n    // 批量注册所有需要的正则\n    if (allNeededIds.size > 0) {\n      await registerMultipleRegexes(Array.from(allNeededIds));\n    }\n  };\n\n  // 防抖包装函数\n  const debouncedProcess = (message_id: number) => {\n    pendingMessageIds.add(message_id);\n\n    if (debounceTimer) {\n      clearTimeout(debounceTimer);\n    }\n\n    // 150ms 防抖延迟\n    debounceTimer = setTimeout(() => {\n      processMessageQueue();\n    }, 150);\n  };\n\n  // 注册单个正则规则（内部使用）\n  const registerSingleRegex = (regex: TavernRegex): boolean => {\n    if (registeredRegexIds.has(regex.id)) {\n      return false; // 已经注册过了\n    }\n\n    registeredRegexIds.add(regex.id);\n    return true;\n  };\n\n  // ===== 优化9: 批量注册 - 减少 await 调用次数 =====\n  const registerMultipleRegexes = async (ids: string[]): Promise<void> => {\n    const allRules = parseRegexRules();\n    const rulesToRegister: TavernRegex[] = [];\n\n    for (const id of ids) {\n      const rule = allRules.find((r: TavernRegex) => r.id === id);\n      if (rule && registerSingleRegex(rule)) {\n        rulesToRegister.push(rule);\n      }\n    }\n\n    if (rulesToRegister.length === 0) return;\n\n    // 获取已存在的正则，合并后一次性更新\n    await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n      // 移除可能存在的同名正则\n      const registeredNames = rulesToRegister.map(r => r.script_name);\n      const filtered = regexes.filter((r: TavernRegex) => !registeredNames.includes(r.script_name));\n      return [...filtered, ...rulesToRegister];\n    });\n\n    // 保存到聊天变量，便于下次加载时恢复\n    const allRegisteredNames = [...loadRegisteredRegexesFromChat(), ...rulesToRegister.map(r => r.script_name)];\n    // 去重\n    const uniqueNames = [...new Set(allRegisteredNames)];\n    saveRegisteredRegexesToChat(uniqueNames);\n\n    console.info(`自适应正则: 已批量注册 ${rulesToRegister.length} 条规则，并保存到聊天变量`);\n  };\n\n  // 移除所有已注册的正则\n  const unregisterAllRegexes = async (): Promise<void> => {\n    if (registeredRegexIds.size === 0) {\n      return;\n    }\n\n    const allRules = parseRegexRules();\n    const registeredNames = Array.from(registeredRegexIds)\n      .map(id => allRules.find((r: TavernRegex) => r.id === id)?.script_name)\n      .filter(Boolean) as string[];\n\n    await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n      return regexes.filter((r: TavernRegex) => !registeredNames.includes(r.script_name));\n    });\n\n    console.info(`自适应正则: 已移除 ${registeredNames.length} 条规则`);\n    registeredRegexIds.clear();\n  };\n\n  // 监听消息接收事件\n  eventOn(tavern_events.MESSAGE_RECEIVED, async (message_id: number) => {\n    debouncedProcess(message_id);\n  });\n\n  // 监听消息编辑事件\n  eventOn(tavern_events.MESSAGE_EDITED, async (message_id: number) => {\n    debouncedProcess(message_id);\n  });\n\n  // ===== 新增: 监听聊天切换事件，打开聊天时同步正则状态 =====\n  eventOn(tavern_events.CHAT_CHANGED, async (chat_file_name: string) => {\n    console.info(`自适应正则: 聊天切换到 ${chat_file_name}，开始同步正则状态`);\n\n    // 获取聊天变量中记录的已注册正则名称\n    const savedNames = loadRegisteredRegexesFromChat();\n    console.info(`自适应正则: 聊天变量中有 ${savedNames.length} 条已注册正则`);\n\n    try {\n      // 获取当前酒馆中实际已注册的正则\n      const allRules = parseRegexRules();\n      let actualRegisteredNames: string[] = [];\n\n      await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n        actualRegisteredNames = regexes.filter(r => savedNames.includes(r.script_name)).map(r => r.script_name);\n        return regexes;\n      });\n\n      console.info(`自适应正则: 酒馆中实际有 ${actualRegisteredNames.length} 条正则`);\n\n      // 需要重新注册的（变量中有但正则中没有）\n      const toReRegister = savedNames.filter(name => !actualRegisteredNames.includes(name));\n      // 需要移除的（变量中没有但正则中有）- 这里不需要主动移除，因为脚本会在卸载时清理\n\n      if (toReRegister.length > 0) {\n        console.info(`自适应正则: 需要重新注册 ${toReRegister.length} 条正则: ${toReRegister.join(', ')}`);\n        // 重新注册缺失的正则\n        const rulesToReRegister = allRules.filter((r: TavernRegex) => toReRegister.includes(r.script_name));\n        if (rulesToReRegister.length > 0) {\n          await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n            const registeredNames = rulesToReRegister.map(r => r.script_name);\n            const filtered = regexes.filter((r: TavernRegex) => !registeredNames.includes(r.script_name));\n            return [...filtered, ...rulesToReRegister];\n          });\n          console.info(`自适应正则: 已重新注册 ${rulesToReRegister.length} 条规则`);\n        }\n      }\n\n      // 将实际注册的名称同步到 existingRegexNames 缓存\n      actualRegisteredNames.forEach(name => existingRegexNames.add(name));\n      toReRegister.forEach(name => existingRegexNames.add(name));\n    } catch (error) {\n      console.error('自适应正则: 聊天切换时同步出错:', error);\n    }\n\n    // 检测最新消息\n    try {\n      const lastMessageId = getLastMessageId();\n      if (lastMessageId >= 0) {\n        const messages = getChatMessages(lastMessageId);\n        if (messages && messages.length > 0) {\n          const msg = messages[0];\n          if (msg?.message_id !== undefined) {\n            debouncedProcess(msg.message_id);\n          }\n        }\n      }\n    } catch (error) {\n      console.error('自适应正则: 检测最新消息出错:', error);\n    }\n  });\n\n  const enabledRules = regexData.filter((r: any) => !r.disabled).length;\n  console.info(`自适应正则: 准备了 ${enabledRules} 条规则用于检测`);\n\n  // ===== 优化10: 初始化时获取酒馆中已存在的正则 =====\n  await initExistingRegexes();\n\n  // 卸载时移除所有已注册的正则\n  $(window).on('pagehide', async () => {\n    if (debounceTimer) {\n      clearTimeout(debounceTimer);\n    }\n    await processMessageQueue();\n    await unregisterAllRegexes();\n    console.info('自适应正则脚本已卸载');\n  });\n});\n"],"names":["$","async","console","info","registeredRegexIds","Set","cachedPatterns","cachedTavernRules","parseRegexRules","filter","rule","disabled","map","id","script_name","scriptName","enabled","scope","find_regex","findRegex","replace_string","replaceString","trim_strings","Array","isArray","trimStrings","join","source","user_input","ai_output","slash_command","world_info","destination","display","prompt","run_on_edit","runOnEdit","min_depth","minDepth","max_depth","maxDepth","existingRegexNames","CHAT_VAR_KEY","loadRegisteredRegexesFromChat","chatVars","getVariables","type","registered","item","e","detectNeededRegexes","messageContent","length","patterns","patternStr","match","pattern","RegExp","quickCheck","includes","tagMatch","startsWith","firstTagMatch","substring","Math","min","name","warn","Boolean","neededIds","has","add","lastIndex","test","push","debounceTimer","pendingMessageIds","processMessageQueue","size","messageIds","from","clear","allNeededIds","message_id","messages","getChatMessages","message","forEach","error","registerMultipleRegexes","debouncedProcess","clearTimeout","setTimeout","registerSingleRegex","regex","ids","allRules","rulesToRegister","find","r","window","TavernHelper","updateTavernRegexesWith","regexes","registeredNames","allRegisteredNames","names","replaceVariables","saveRegisteredRegexesToChat","eventOn","tavern_events","MESSAGE_RECEIVED","MESSAGE_EDITED","CHAT_CHANGED","chat_file_name","savedNames","actualRegisteredNames","toReRegister","rulesToReRegister","lastMessageId","getLastMessageId","msg","undefined","enabledRules","initExistingRegexes","on","unregisterAllRegexes"],"sourceRoot":""}