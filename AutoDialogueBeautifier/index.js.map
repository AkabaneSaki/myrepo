{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/自适应正则脚本/index.ts"],"sourcesContent":["// 自适应正则脚本\n// 功能：检测AI输出聊天中存在表达式内容时，自动注册相应的正则规则\n// 卸载时自动移除所有其注册的正则\n\nimport regexData from './regex.json';\n\n$(async () => {\n  console.info('自适应正则脚本已加载');\n\n  // 已注册的正则ID列表\n  const registeredRegexIds: string[] = [];\n\n  // 解析正则数据，转换为酒馆正则格式\n  const parseRegexRules = (): TavernRegex[] => {\n    return regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => ({\n        id: rule.id,\n        script_name: rule.scriptName,\n        enabled: true,\n        scope: 'global' as const,\n        find_regex: rule.findRegex,\n        replace_string: rule.replaceString,\n        trim_strings: Array.isArray(rule.trimStrings) ? rule.trimStrings.join('\\n') : '',\n        source: {\n          user_input: false,\n          ai_output: true,\n          slash_command: false,\n          world_info: false,\n        },\n        destination: {\n          display: true,\n          prompt: false,\n        },\n        run_on_edit: rule.runOnEdit ?? true,\n        min_depth: rule.minDepth ?? null,\n        max_depth: rule.maxDepth ?? 10,\n      }));\n  };\n\n  // 从正则规则中提取检测模式\n  // 用于快速检测消息中是否包含需要正则处理的表达式\n  const extractDetectionPatterns = (): { id: string; pattern: RegExp; name: string }[] => {\n    return regexData\n      .filter((rule: any) => !rule.disabled)\n      .map((rule: any) => {\n        // 清理正则表达式，移除开头的 / 和结尾的 /g 等修饰符\n        let patternStr = rule.findRegex;\n\n        // 处理 /pattern/flags 格式\n        const match = patternStr.match(/^\\/(.+)\\/([gimsuy]*)$/);\n        if (match) {\n          patternStr = match[1];\n        }\n\n        // 尝试创建正则，使用 'i' 标志忽略大小写以提高匹配率\n        try {\n          const pattern = new RegExp(patternStr, 'i');\n          return {\n            id: rule.id,\n            pattern,\n            name: rule.scriptName,\n          };\n        } catch (e) {\n          console.warn(`无效的正则表达式: ${patternStr}`, e);\n          return null;\n        }\n      })\n      .filter(Boolean) as { id: string; pattern: RegExp; name: string }[];\n  };\n\n  // 检测消息中是否包含需要处理的表达式\n  const detectNeededRegexes = (messageContent: string): string[] => {\n    const patterns = extractDetectionPatterns();\n    const neededIds: string[] = [];\n\n    for (const { id, pattern, name } of patterns) {\n      try {\n        if (pattern.test(messageContent)) {\n          neededIds.push(id);\n          console.info(`检测到表达式: ${name}`);\n        }\n      } catch (e) {\n        // 忽略正则测试错误\n      }\n    }\n\n    return neededIds;\n  };\n\n  // 注册单个正则规则\n  const registerRegex = async (regex: TavernRegex): Promise<void> => {\n    if (registeredRegexIds.includes(regex.id)) {\n      return; // 已经注册过了\n    }\n\n    await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n      // 移除可能存在的同名正则\n      const filtered = regexes.filter((r: TavernRegex) => r.script_name !== regex.script_name);\n      return [...filtered, regex];\n    });\n\n    registeredRegexIds.push(regex.id);\n    console.info(`已注册正则: ${regex.script_name}`);\n  };\n\n  // 批量注册多个正则\n  const registerMultipleRegexes = async (ids: string[]): Promise<void> => {\n    const allRules = parseRegexRules();\n\n    for (const id of ids) {\n      const rule = allRules.find((r: TavernRegex) => r.id === id);\n      if (rule) {\n        await registerRegex(rule);\n      }\n    }\n  };\n\n  // 移除所有已注册的正则\n  const unregisterAllRegexes = async (): Promise<void> => {\n    if (registeredRegexIds.length === 0) {\n      return;\n    }\n\n    const allRules = parseRegexRules();\n    const registeredNames = registeredRegexIds\n      .map(id => allRules.find((r: TavernRegex) => r.id === id)?.script_name)\n      .filter(Boolean) as string[];\n\n    await window.TavernHelper.updateTavernRegexesWith((regexes: TavernRegex[]) => {\n      return regexes.filter((r: TavernRegex) => !registeredNames.includes(r.script_name));\n    });\n\n    console.info(`已移除 ${registeredNames.length} 条自适应正则规则`);\n    registeredRegexIds.length = 0;\n  };\n\n  // 监听消息接收事件 - 只检测最新收到的消息（对应 message_id 楼层）\n  eventOn(tavern_events.MESSAGE_RECEIVED, async (message_id: number) => {\n    try {\n      // 只获取 message_id 对应的特定楼层，而不是所有消息\n      const messages = getChatMessages(message_id);\n      if (!messages || messages.length === 0) {\n        return;\n      }\n\n      const messageContent = messages[0].message;\n\n      // 检测需要注册的正则\n      const neededIds = detectNeededRegexes(messageContent);\n\n      if (neededIds.length > 0) {\n        // 注册所有匹配的正则\n        await registerMultipleRegexes(neededIds);\n      }\n    } catch (error) {\n      console.error('自适应正则处理出错:', error);\n    }\n  });\n\n  // 监听消息编辑事件 - 只检测被编辑的消息楼层\n  eventOn(tavern_events.MESSAGE_EDITED, async (message_id: number) => {\n    try {\n      // 只获取被编辑的特定楼层\n      const messages = getChatMessages(message_id);\n      if (!messages || messages.length === 0) {\n        return;\n      }\n\n      const messageContent = messages[0].message;\n\n      // 检测需要注册的正则\n      const neededIds = detectNeededRegexes(messageContent);\n\n      if (neededIds.length > 0) {\n        // 注册所有匹配的正则\n        await registerMultipleRegexes(neededIds);\n      }\n    } catch (error) {\n      console.error('自适应正则处理(编辑)出错:', error);\n    }\n  });\n\n  console.info(`自适应正则脚本: 准备了 ${regexData.filter((r: any) => !r.disabled).length} 条正则规则用于检测`);\n\n  // 卸载时移除所有已注册的正则\n  $(window).on('pagehide', async () => {\n    await unregisterAllRegexes();\n    console.info('自适应正则脚本已卸载');\n  });\n});\n"],"names":["$","async","console","info","registeredRegexIds","parseRegexRules","filter","rule","disabled","map","id","script_name","scriptName","enabled","scope","find_regex","findRegex","replace_string","replaceString","trim_strings","Array","isArray","trimStrings","join","source","user_input","ai_output","slash_command","world_info","destination","display","prompt","run_on_edit","runOnEdit","min_depth","minDepth","max_depth","maxDepth","detectNeededRegexes","messageContent","patterns","patternStr","match","pattern","RegExp","name","e","warn","Boolean","neededIds","test","push","registerRegex","regex","includes","window","TavernHelper","updateTavernRegexesWith","regexes","r","registerMultipleRegexes","ids","allRules","find","eventOn","tavern_events","MESSAGE_RECEIVED","message_id","messages","getChatMessages","length","message","error","MESSAGE_EDITED","on","registeredNames","unregisterAllRegexes"],"sourceRoot":""}