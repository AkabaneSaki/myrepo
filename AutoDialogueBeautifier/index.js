$(async()=>{console.info('自适应正则脚本已加载');let n=[];try{console.info('自适应正则: 正在从网络加载 regex.json...');const e=await fetch('https://cdn.jsdelivr.net/gh/AkabaneSaki/myrepo@main/AutoDialogueBeautifier/regex.json');if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);n=await e.json(),console.info(`自适应正则: 成功从网络加载 ${n.length} 条规则`)}catch(n){return console.error('自适应正则: 从网络加载失败:',n),void toastr.error('自适应正则: 加载规则失败，请检查网络连接')}const e='adaptive_regex_names';let t=!1,o=null,s=null,i=null,c=null;console.info(`自适应正则: 成功加载 ${n.length} 条规则`);const a=()=>(null!==c||(c=n.filter(n=>!n.disabled).map(n=>({id:n.id,script_name:n.scriptName,enabled:!0,scope:'character',find_regex:n.findRegex,replace_string:n.replaceString,trim_strings:Array.isArray(n.trimStrings)?n.trimStrings.join('\n'):'',source:{user_input:!1,ai_output:!0,slash_command:!1,world_info:!1},destination:{display:!0,prompt:!1},run_on_edit:n.runOnEdit??!0,min_depth:n.minDepth??null,max_depth:n.maxDepth??10}))),c),r=(e,t=[])=>{if(!e||e.length<3)return[];const o=(()=>{if(null!==i)return i;const e=n.filter(n=>!n.disabled).map(n=>{let e=n.findRegex;const t=e.match(/^\/(.+)\/([gimsuy]*)$/);t&&(e=t[1]);try{const t=new RegExp(e,'i');let o='';if(e.includes('{')||e.includes('\\{'))o='{';else if(e.includes('<')||e.includes('\\<')){const n=e.match(/<(\w+)/);n&&(o=`<${n[1]}`)}else if(e.includes('\\[')||e.includes('\\]'))o='[';else if(e.includes('\\(')||e.includes('\\)'))o='(';else if(e.startsWith('>'))o='>';else if(e.startsWith('<')){const n=e.match(/<(\w+)/);n&&(o=`<${n[1]}`)}else o=e.substring(0,Math.min(15,e.length));return{scriptName:n.scriptName,pattern:t,quickCheck:o}}catch(n){return console.warn(`无效的正则表达式: ${e}`,n),null}}).filter(Boolean);return i=e,e})(),s=[],c=new Set(t);for(const{scriptName:n,pattern:t,quickCheck:i}of o)if(!c.has(n)&&(!i||e.includes(i)))try{t.lastIndex=0,t.test(e)&&(s.push(n),console.info(`自适应正则: 检测到 ${n}`))}catch(n){}return s},l=()=>{try{const n=getVariables({type:'chat'}),t=n?.[e];if(Array.isArray(t))return t.filter(n=>'string'==typeof n)}catch(n){console.warn('获取存储的正则名称失败:',n)}return[]},f=async n=>{try{await updateTavernRegexesWith(e=>[...e.filter(e=>e.script_name!==n.script_name),n])}catch(e){console.warn(`注册正则失败: ${n.script_name}`,e)}},h=async()=>{if(t)console.info('自适应正则: 正在同步中，跳过本次调用');else try{t=!0;const n=l(),e=new Set(n),o=await(async()=>{const n=new Set;try{await updateTavernRegexesWith(e=>(e.forEach(e=>n.add(e.script_name)),e))}catch(n){console.warn('获取角色卡正则列表失败:',n)}return n})(),s=new Set(o),i=new Set(a().map(n=>n.script_name)),c=[];for(const n of o)!e.has(n)&&i.has(n)&&c.push(n);const r=[];for(const e of n)s.has(e)||r.push(e);if(c.length>0&&(await u(c),console.info(`自适应正则: 已移除 ${c.length} 条不在变量列表中的规则: ${c.join(', ')}`)),r.length>0){const n=a();let e=0;for(const t of r){const o=n.find(n=>n.script_name===t);o&&(await f(o),e++,console.info(`自适应正则: 已注册 ${t}`))}e>0&&console.info(`自适应正则: 共注册了 ${e} 条规则`)}0===c.length&&0===r.length&&console.info('自适应正则: 变量列表与角色卡正则列表已同步，无需更新')}catch(n){console.error('同步正则列表失败:',n)}finally{t=!1}},u=async n=>{if(0!==n.length)try{await updateTavernRegexesWith(e=>e.filter(e=>!n.includes(e.script_name))),console.info(`自适应正则: 已移除 ${n.length} 条规则`)}catch(n){console.warn('移除正则失败:',n)}},p=async()=>{try{console.info('自适应正则: 开始扫描最后一层消息');const n=getChatMessages(-1);if(console.info('自适应正则: 获取到的消息:',n),!n||0===n.length)return void console.info('自适应正则: 没有找到消息，返回');const t=n[0].message;console.info('自适应正则: 消息内容:',t);const o=l();console.info('自适应正则: 已存储的正则名称:',o);const s=r(t,o);console.info('自适应正则: 检测到的新正则名称:',s);const i=[...new Set([...o,...s])];console.info('自适应正则: 合并后的正则名称:',i);const c=[...o].sort().join(','),a=[...i].sort().join(',');console.info('自适应正则: 排序后的存储名称:',c),console.info('自适应正则: 排序后的合并名称:',a),c!==a?(console.info(`自适应正则: 检测到变化，从 ${o.length} 个更新到 ${i.length} 个`),(n=>{try{const t=[...n].sort();replaceVariables({[e]:t},{type:'chat'}),console.info(`自适应正则: 已保存 ${t.length} 个正则名称到聊天变量`)}catch(n){console.warn('保存正则名称失败:',n)}})(i),await h()):console.info('自适应正则: 无变化，不更新')}catch(n){console.error('扫描消息更新变量失败:',n)}};let d=[];eventOn(tavern_events.MESSAGE_RECEIVED,async n=>{console.info(`自适应正则: 收到新消息 ${n}，扫描最新楼层`),await p()}),eventOn(tavern_events.CHAT_CHANGED,async n=>{console.info(`自适应正则: 检测到聊天切换到 ${n}`),o!==n&&(o=n,s&&clearTimeout(s),s=setTimeout(async()=>{t||await h()},500))}),$(window).on('pagehide',async()=>{const n=l();n.length>0&&(await u(n),console.info(`自适应正则: 已卸载 ${n.length} 条规则`)),console.info('自适应正则脚本已卸载')}),console.info('自适应正则: 启动初始化'),await(async()=>{const n=l();n.length>0?(console.info(`自适应正则: 初始化，从变量加载 ${n.length} 个正则`),await h()):(console.info('自适应正则: 变量为空，扫描当前消息'),await p())})(),(()=>{d=l();const n=replaceVariables;window.replaceVariables=function(e,o){const i=n.call(this,e,o);if(!(t||'chat'!==o?.type&&o)){[...l()].sort().join(',')!==[...d].sort().join(',')&&(console.info('自适应正则: 变量发生变化，刷新正则列表'),s&&clearTimeout(s),s=setTimeout(()=>{h().then(()=>{d=l()})},500))}return i}})();const g=n.filter(n=>!n.disabled).length;console.info(`自适应正则: 准备了 ${g} 条规则用于检测`)});
//# sourceMappingURL=index.js.map