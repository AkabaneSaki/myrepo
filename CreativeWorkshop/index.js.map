{"version":3,"file":"index.js","mappings":"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","sources":["src://tavern_helper_template/src/创意工坊/index.ts"],"sourcesContent":["// ==================== 创意工坊脚本 ====================\n// 基于原 创意工坊.js 改编为酒馆助手脚本格式\n\n$(() => {\n  // ==================== 常量 ====================\n  const CDN_BASE = 'https://cdn.jsdelivr.net/gh/AkabaneSaki/myrepo@main';\n  const CATALOG_URL = `${CDN_BASE}/system/catalog.json`;\n  const CHARACTER_CATALOG_URL = `${CDN_BASE}/character/catalog.json`;\n  const CHARACTER_CONTENT_BASE = `${CDN_BASE}/character/`;\n  const RACE_CATALOG_URL = `${CDN_BASE}/race/catalog.json`;\n  const RACE_CONTENT_BASE = `${CDN_BASE}/race/`;\n  const WB_SEARCH_MARKER = '（工坊MOD）';\n  const CONFIG_KEY = 'fate_updater_config_v2';\n  const RACE_OVERVIEW_ENTRY_NAME = '种族概览';\n\n  const PRESET_THEMES = {\n    default: { name: '默认深色', bgColor: '#0F172A', cardColor: '#1E293B', textColor: '#E2E8F0' },\n    light: { name: '明亮浅色', bgColor: '#F8FAFC', cardColor: '#FFFFFF', textColor: '#0F172A' },\n    night: { name: '纯粹黑夜', bgColor: '#000000', cardColor: '#0A0A0A', textColor: '#A0A0A0' },\n    forest: { name: '自然森林', bgColor: '#0F3B1E', cardColor: '#1B4D2A', textColor: '#E0F2E0' },\n    cyber: { name: '赛博霓虹', bgColor: '#0D0B1A', cardColor: '#2A1E4A', textColor: '#00FFFF' },\n  };\n\n  const DEFAULT_CONFIG = {\n    bgColor: '#0F172A',\n    cardColor: '#1E293B',\n    textColor: '#E2E8F0',\n    width: 900,\n    height: 85,\n  };\n\n  // ==================== 工具函数 ====================\n  const adjustColor = (color: string, amount: number): string => {\n    let hex = color.replace(/^#/, '');\n    if (hex.length === 3) {\n      hex = hex\n        .split('')\n        .map(c => c + c)\n        .join('');\n    }\n    const num = parseInt(hex, 16);\n    let r = (num >> 16) + amount;\n    let g = ((num >> 8) & 0xff) + amount;\n    let b = (num & 0xff) + amount;\n    r = Math.max(0, Math.min(255, r));\n    g = Math.max(0, Math.min(255, g));\n    b = Math.max(0, Math.min(255, b));\n    return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;\n  };\n\n  const getConfig = (): typeof DEFAULT_CONFIG => {\n    try {\n      const stored = localStorage.getItem(CONFIG_KEY);\n      if (stored) return { ...DEFAULT_CONFIG, ...JSON.parse(stored) };\n    } catch (e) {\n      // ignore\n    }\n    return { ...DEFAULT_CONFIG };\n  };\n\n  const saveConfig = (cfg: typeof DEFAULT_CONFIG): void => {\n    localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));\n  };\n\n  const isLightColor = (hex: string): boolean => {\n    const r = parseInt(hex.slice(1, 3), 16);\n    const g = parseInt(hex.slice(3, 5), 16);\n    const b = parseInt(hex.slice(5, 7), 16);\n    return (r * 299 + g * 587 + b * 114) / 1000 > 155;\n  };\n\n  // ==================== 模态框管理 ====================\n  const closeModal = (): void => {\n    const doc = window.top?.document || document;\n    const el = doc.getElementById('custom-system-modal');\n    if (el) el.remove();\n  };\n  (window as any).closeCustomModal = closeModal;\n\n  const injectGlobalStyles = (doc: Document): void => {\n    const styleId = 'fate-updater-styles-v3';\n    if (doc.getElementById(styleId)) return;\n    const style = doc.createElement('style');\n    style.id = styleId;\n    style.textContent = `\n      .fate-modal-overlay {\n        backdrop-filter: blur(8px);\n        background-color: rgba(0, 0, 0, 0.6);\n      }\n      .fate-modal-content {\n        background: var(--bg-color) !important;\n        color: var(--text-color);\n        border-radius: 24px;\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);\n        transition: all 0.2s ease;\n      }\n      .fate-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 16px 20px;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      }\n      .fate-header h3 {\n        margin: 0;\n        font-size: 1.3rem;\n        font-weight: 600;\n        color: var(--text-color);\n        letter-spacing: 0.5px;\n      }\n      .fate-icon-btn {\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 40px;\n        width: 36px;\n        height: 36px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        color: var(--text-color);\n        font-size: 18px;\n        transition: all 0.2s;\n      }\n      .fate-icon-btn:hover {\n        background: rgba(255, 255, 255, 0.2);\n        transform: scale(1.05);\n      }\n      .fate-search {\n        margin: 0 20px 16px 20px;\n      }\n      .fate-search input {\n        width: 100%;\n        padding: 12px 20px;\n        background: rgba(0, 0, 0, 0.3);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 40px;\n        color: var(--text-color);\n        font-size: 1rem;\n        outline: none;\n        transition: 0.2s;\n      }\n      .fate-search input:focus {\n        border-color: var(--highlight-color);\n        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);\n      }\n      .fate-main-container {\n        flex: 1;\n        min-height: 0;\n        display: flex;\n        gap: 16px;\n        padding: 0 20px 20px 20px;\n      }\n      .fate-grid {\n        flex: 1;\n        display: grid;\n        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));\n        gap: 12px;\n        overflow-y: auto;\n        padding-right: 6px;\n        min-height: 0;\n      }\n      .fate-card {\n        background: linear-gradient(145deg, var(--card-base), var(--card-dark));\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 20px;\n        padding: 10px 8px;\n        display: flex;\n        flex-direction: column;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.3);\n        position: relative;\n        overflow: hidden;\n        height: auto;\n        min-height: 90px;\n      }\n      .fate-card:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);\n        border-color: var(--highlight-color);\n      }\n      .fate-card.selected-card {\n        border: 2px solid var(--highlight-color);\n        background: linear-gradient(145deg, var(--card-light), var(--card-base));\n      }\n      .fate-card-title {\n        font-weight: 600;\n        font-size: 0.95rem;\n        text-align: center;\n        margin-bottom: 4px;\n        color: var(--text-color);\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      .fate-card-sep {\n        height: 1px;\n        background: rgba(255, 255, 255, 0.2);\n        margin: 2px 0 4px 0;\n      }\n      .fate-card-info {\n        font-size: 0.7rem;\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n        color: var(--text-color);\n        opacity: 0.9;\n      }\n      .fate-info-row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        flex-wrap: nowrap;\n      }\n      .fate-info-value {\n        font-weight: 600;\n        min-width: 100px;\n        text-align: right;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n        margin-left: 8px;\n        flex: 1;\n      }\n      .fate-selected-indicator {\n        position: absolute;\n        bottom: 4px;\n        right: 8px;\n        color: var(--highlight-color);\n        font-size: 18px;\n        display: none;\n      }\n      .fate-preview-wrapper {\n        display: none;\n        width: 60%;\n        flex-direction: column;\n        gap: 12px;\n        overflow-y: auto;\n        padding: 0;\n        min-height: 0;\n      }\n      .fate-preview-wrapper .fate-accordion {\n        width: 100%;\n      }\n      .fate-accordion {\n        background: rgba(0, 0, 0, 0.2);\n        border-radius: 16px;\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        overflow: hidden;\n        backdrop-filter: blur(4px);\n      }\n      .fate-accord-header {\n        padding: 12px 16px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        cursor: pointer;\n        background: rgba(255, 255, 255, 0.03);\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        font-weight: 500;\n        transition: 0.2s;\n      }\n      .fate-accord-header:hover {\n        background: rgba(255, 255, 255, 0.08);\n      }\n      .fate-accord-body {\n        padding: 16px;\n        max-height: 300px;\n        overflow-y: auto;\n        transition: 0.2s;\n      }\n      .fate-detail-container {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n      .fate-detail-item {\n        display: flex;\n        border-bottom: 1px dashed rgba(255,255,255,0.1);\n        padding: 6px 0;\n      }\n      .fate-detail-label {\n        width: 80px;\n        opacity: 0.7;\n      }\n      .fate-detail-value {\n        flex: 1;\n        text-align: right;\n        font-weight: 500;\n      }\n      .fate-preview-content {\n        background: rgba(0, 0, 0, 0.3);\n        border-radius: 12px;\n        padding: 12px;\n        font-family: 'Fira Code', monospace;\n        font-size: 12px;\n        white-space: pre-wrap;\n        max-height: 300px;\n        overflow-y: auto;\n      }\n      .fate-footer {\n        padding: 16px 20px;\n        border-top: 1px solid rgba(255,255,255,0.1);\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      }\n      .fate-selected-label {\n        font-size: 0.9rem;\n        opacity: 0.8;\n      }\n      .fate-apply-btn {\n        background: linear-gradient(135deg, #2E7D32, #1B5E20);\n        border: none;\n        border-radius: 40px;\n        padding: 10px 28px;\n        color: white;\n        font-weight: 600;\n        cursor: pointer;\n        transition: 0.2s;\n        box-shadow: 0 4px 10px rgba(0, 80, 0, 0.4);\n      }\n      .fate-apply-btn:not(:disabled):hover {\n        transform: scale(1.02);\n        filter: brightness(1.2);\n      }\n      .fate-apply-btn:disabled {\n        opacity: 0.4;\n        cursor: not-allowed;\n      }\n      .fate-sys-mode-split .fate-grid {\n        grid-template-columns: 1fr;\n        max-width: 240px;\n      }\n      .fate-sys-mode-split .fate-card {\n        padding: 8px;\n        height: auto;\n        min-height: 40px;\n      }\n      .fate-sys-mode-split .fate-card-info {\n        display: none;\n      }\n      .fate-sys-mode-split .fate-card-title {\n        font-size: 0.85rem;\n        margin-bottom: 0;\n      }\n      .fate-sys-mode-split .fate-card-sep {\n        display: none;\n      }\n    `;\n    doc.head.appendChild(style);\n  };\n\n  const showModal = (\n    htmlContent: string,\n    afterRenderCallback?: (doc: Document, modalContent: HTMLElement) => void,\n  ): void => {\n    let targetDoc = document;\n    try {\n      if (window.top?.document) targetDoc = window.top.document;\n    } catch (e) {\n      // cross-origin\n    }\n\n    const existing = targetDoc.getElementById('custom-system-modal');\n    if (existing) existing.remove();\n\n    const config = getConfig();\n    injectGlobalStyles(targetDoc);\n\n    const modalOverlay = targetDoc.createElement('div');\n    modalOverlay.id = 'custom-system-modal';\n    modalOverlay.className = 'fate-modal-overlay';\n    Object.assign(modalOverlay.style, {\n      position: 'fixed',\n      top: '0',\n      left: '0',\n      width: '100%',\n      height: '100%',\n      zIndex: '2147483647',\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'flex-start',\n      paddingTop: '60px',\n    });\n\n    const modalContent = targetDoc.createElement('div');\n    modalContent.className = 'fate-modal-content';\n    Object.assign(modalContent.style, {\n      backgroundColor: config.bgColor,\n      maxWidth: config.width + 'px',\n      width: '95%',\n      maxHeight: config.height + 'vh',\n      display: 'flex',\n      flexDirection: 'column',\n    });\n\n    const cardDark = adjustColor(config.cardColor, -20);\n    const cardLight = adjustColor(config.cardColor, 20);\n    modalContent.style.setProperty('--bg-color', config.bgColor);\n    modalContent.style.setProperty('--card-base', config.cardColor);\n    modalContent.style.setProperty('--card-dark', cardDark);\n    modalContent.style.setProperty('--card-light', cardLight);\n    modalContent.style.setProperty('--text-color', config.textColor);\n    modalContent.style.setProperty('--highlight-color', isLightColor(config.bgColor) ? '#FF6F00' : '#FFD700');\n\n    modalContent.innerHTML = htmlContent;\n    modalOverlay.appendChild(modalContent);\n    targetDoc.body.appendChild(modalOverlay);\n    modalOverlay.onclick = e => {\n      if (e.target === modalOverlay) closeModal();\n    };\n\n    if (afterRenderCallback) afterRenderCallback(targetDoc, modalContent);\n  };\n\n  // ==================== 通用UI组件 ====================\n  const renderGrid = (\n    items: any[],\n    config: typeof DEFAULT_CONFIG,\n    cardRenderer: (item: any, ctx: any) => string,\n  ): string => {\n    const ctx = {\n      cardBase: config.cardColor,\n      cardDark: adjustColor(config.cardColor, -20),\n      textColor: config.textColor,\n    };\n    return items.map(item => cardRenderer(item, ctx)).join('');\n  };\n\n  interface SelectorOptions {\n    title: string;\n    icon: string;\n    searchPlaceholder: string;\n    catalogUrl: string;\n    sortFn?: (a: any, b: any) => number;\n    catalogProcessor?: (catalog: Record<string, any>) => void;\n    cardRenderer: (item: any, ctx: any) => string;\n    detailRenderer: (key: string, meta: any) => string;\n    previewUrlBase: string;\n    previewExt?: string;\n    multiSelect?: boolean;\n    onApply?: (keys: string[], catalog: Record<string, any>) => Promise<void>;\n    fromMain?: boolean;\n  }\n\n  const createSelectorModal = async (options: SelectorOptions): Promise<void> => {\n    const {\n      title,\n      icon,\n      searchPlaceholder,\n      catalogUrl,\n      sortFn,\n      catalogProcessor,\n      cardRenderer,\n      detailRenderer,\n      previewUrlBase,\n      previewExt = '.txt',\n      multiSelect = false,\n      onApply,\n      fromMain = false,\n    } = options;\n\n    const config = getConfig();\n\n    let list: any[] = [];\n    let catalog: Record<string, any> = {};\n    try {\n      const data = await fetchCatalog(catalogUrl, sortFn);\n      catalog = data.catalog;\n      if (catalogProcessor) {\n        catalogProcessor(catalog);\n        list = Object.keys(catalog).map(key => ({ key, ...catalog[key] }));\n        if (sortFn) list.sort(sortFn);\n      } else {\n        list = data.list;\n      }\n    } catch (e: any) {\n      toastr.error(`加载目录失败: ${e.message}`);\n      return;\n    }\n\n    const gridHtml = renderGrid(list, config, cardRenderer);\n    const modalIdPrefix = Math.random().toString(36).substring(7);\n\n    const ids = {\n      grid: `${modalIdPrefix}-grid`,\n      preview: `${modalIdPrefix}-preview`,\n      main: `${modalIdPrefix}-main`,\n      toggle: `${modalIdPrefix}-toggle`,\n      settings: `${modalIdPrefix}-settings`,\n      back: `${modalIdPrefix}-back`,\n      search: `${modalIdPrefix}-search`,\n      apply: `${modalIdPrefix}-apply`,\n      label: `${modalIdPrefix}-label`,\n      detail: `${modalIdPrefix}-detail`,\n      previewContent: `${modalIdPrefix}-preview-content`,\n      accordInfoHead: `${modalIdPrefix}-info-head`,\n      accordInfoBody: `${modalIdPrefix}-info-body`,\n      accordInfoArrow: `${modalIdPrefix}-info-arrow`,\n      accordPrevHead: `${modalIdPrefix}-prev-head`,\n      accordPrevBody: `${modalIdPrefix}-prev-body`,\n      accordPrevArrow: `${modalIdPrefix}-prev-arrow`,\n      accordPrevItem: `${modalIdPrefix}-prev-item`,\n    };\n\n    const html = `\n      <div class=\"fate-header\">\n        <h3><i class=\"${icon}\" style=\"margin-right:10px;\"></i>${title}</h3>\n        <div style=\"display:flex; gap:8px;\">\n          ${fromMain ? `<button class=\"fate-icon-btn\" id=\"${ids.back}\" title=\"返回主菜单\"><i class=\"fas fa-arrow-left\"></i></button>` : ''}\n          <button class=\"fate-icon-btn\" id=\"${ids.toggle}\" title=\"切换视图\"><i class=\"fas fa-th-large\"></i></button>\n          <button class=\"fate-icon-btn\" id=\"${ids.settings}\" title=\"界面设置\"><i class=\"fas fa-cog\"></i></button>\n        </div>\n      </div>\n      <div class=\"fate-search\">\n        <input type=\"text\" id=\"${ids.search}\" placeholder=\"${searchPlaceholder}\">\n      </div>\n      <div class=\"fate-main-container\" id=\"${ids.main}\">\n        <div class=\"fate-grid\" id=\"${ids.grid}\">\n          ${gridHtml}\n        </div>\n        <div class=\"fate-preview-wrapper\" id=\"${ids.preview}\">\n          <div class=\"fate-accordion\">\n            <div class=\"fate-accord-header\" id=\"${ids.accordInfoHead}\">\n              <span><i class=\"far fa-file-alt\" style=\"margin-right:8px;\"></i>详情信息</span>\n              <i class=\"fas fa-chevron-down\" id=\"${ids.accordInfoArrow}\"></i>\n            </div>\n            <div class=\"fate-accord-body\" id=\"${ids.accordInfoBody}\">\n              <div id=\"${ids.detail}\" class=\"fate-detail-container\">\n                <div style=\"opacity:0.5; text-align:center; padding:20px;\">请选择左侧项目查看详情</div>\n              </div>\n            </div>\n          </div>\n          <div class=\"fate-accordion\" id=\"${ids.accordPrevItem}\">\n            <div class=\"fate-accord-header\" id=\"${ids.accordPrevHead}\">\n              <span><i class=\"fas fa-eye\" style=\"margin-right:8px;\"></i>内容预览</span>\n              <i class=\"fas fa-chevron-right\" id=\"${ids.accordPrevArrow}\"></i>\n            </div>\n            <div class=\"fate-accord-body\" id=\"${ids.accordPrevBody}\" style=\"display:none;\">\n              <pre id=\"${ids.previewContent}\" class=\"fate-preview-content\"></pre>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"fate-footer\">\n        <span class=\"fate-selected-label\" id=\"${ids.label}\">未选择任何项目</span>\n        <button class=\"fate-apply-btn\" id=\"${ids.apply}\" disabled>应用选中项</button>\n      </div>\n    `;\n\n    showModal(html, (doc, modalContent) => {\n      if (fromMain) {\n        const backBtn = doc.getElementById(ids.back);\n        if (backBtn) {\n          backBtn.onclick = () => {\n            closeModal();\n            openMainPanel();\n          };\n        }\n      }\n\n      const settingsBtn = doc.getElementById(ids.settings);\n      if (settingsBtn) {\n        settingsBtn.onclick = e => {\n          e.stopPropagation();\n          openSystemUpdaterSettings();\n        };\n      }\n\n      const gridWrapper = doc.getElementById(ids.grid) as HTMLElement;\n      const previewWrapper = doc.getElementById(ids.preview) as HTMLElement;\n      const mainContainer = doc.getElementById(ids.main) as HTMLElement;\n      const toggleBtn = doc.getElementById(ids.toggle) as HTMLButtonElement;\n      const viewToggler = createViewToggler(gridWrapper, previewWrapper, mainContainer, toggleBtn);\n      toggleBtn.onclick = viewToggler;\n\n      const headInfo = doc.getElementById(ids.accordInfoHead) as HTMLElement;\n      const bodyInfo = doc.getElementById(ids.accordInfoBody) as HTMLElement;\n      const arrowInfo = doc.getElementById(ids.accordInfoArrow) as HTMLElement;\n      const headPreview = doc.getElementById(ids.accordPrevHead) as HTMLElement;\n      const bodyPreview = doc.getElementById(ids.accordPrevBody) as HTMLElement;\n      const arrowPreview = doc.getElementById(ids.accordPrevArrow) as HTMLElement;\n      const itemPreview = doc.getElementById(ids.accordPrevItem) as HTMLElement;\n\n      const toggleAccordion = (target: string) => {\n        const isInfoOpen = bodyInfo.style.display !== 'none';\n        const isPreviewOpen = bodyPreview.style.display !== 'none';\n        if (target === 'info') {\n          if (isInfoOpen) {\n            bodyInfo.style.display = 'none';\n            arrowInfo.className = 'fas fa-chevron-right';\n          } else {\n            bodyInfo.style.display = 'block';\n            arrowInfo.className = 'fas fa-chevron-down';\n            bodyPreview.style.display = 'none';\n            arrowPreview.className = 'fas fa-chevron-right';\n            itemPreview.style.border = '';\n            itemPreview.style.background = '';\n            itemPreview.style.minHeight = '';\n            headPreview.style.borderBottom = '';\n            bodyPreview.style.border = '';\n            bodyPreview.style.padding = '';\n          }\n        } else if (isPreviewOpen) {\n          bodyPreview.style.display = 'none';\n          arrowPreview.className = 'fas fa-chevron-right';\n          itemPreview.style.border = '';\n          itemPreview.style.background = '';\n          itemPreview.style.minHeight = '';\n          headPreview.style.borderBottom = '';\n          bodyPreview.style.border = '';\n          bodyPreview.style.padding = '';\n        } else {\n          bodyInfo.style.display = 'none';\n          arrowInfo.className = 'fas fa-chevron-right';\n          bodyPreview.style.display = 'flex';\n          arrowPreview.className = 'fas fa-chevron-down';\n          itemPreview.style.border = '1px solid rgba(255,255,255,0.2)';\n          itemPreview.style.background = 'rgba(0,0,0,0.1)';\n          itemPreview.style.minHeight = '200px';\n          headPreview.style.borderBottom = '1px solid rgba(255,255,255,0.1)';\n          bodyPreview.style.border = 'none';\n          bodyPreview.style.padding = '0';\n        }\n      };\n\n      headInfo.onclick = () => toggleAccordion('info');\n      headPreview.onclick = () => toggleAccordion('preview');\n\n      const searchInput = doc.getElementById(ids.search) as HTMLInputElement;\n      searchInput.oninput = e => {\n        const term = (e.target as HTMLInputElement).value.toLowerCase();\n        gridWrapper.querySelectorAll('.fate-card').forEach(card => {\n          const searchData = (card as HTMLElement).dataset.search || '';\n          (card as HTMLElement).style.display = searchData.includes(term) ? 'flex' : 'none';\n        });\n      };\n      searchInput.focus();\n\n      const selectedKeysSet = new Set<string>();\n      let lastClickedKey: string | null = null;\n      const applyBtn = doc.getElementById(ids.apply) as HTMLButtonElement;\n      const label = doc.getElementById(ids.label) as HTMLElement;\n      const detailContainer = doc.getElementById(ids.detail) as HTMLElement;\n      const previewContent = doc.getElementById(ids.previewContent) as HTMLElement;\n\n      const refreshUI = () => {\n        const count = selectedKeysSet.size;\n        gridWrapper.querySelectorAll('.fate-card').forEach(card => {\n          const key = (card as HTMLElement).dataset.key;\n          if (selectedKeysSet.has(key || '')) {\n            card.classList.add('selected-card');\n            const indicator = card.querySelector('.fate-selected-indicator') as HTMLElement;\n            if (indicator) indicator.style.display = 'block';\n            (card as HTMLElement).style.border = `2px solid var(--highlight-color)`;\n            (card as HTMLElement).style.background = `linear-gradient(145deg, var(--card-light), var(--card-base))`;\n          } else {\n            card.classList.remove('selected-card');\n            const indicator = card.querySelector('.fate-selected-indicator') as HTMLElement;\n            if (indicator) indicator.style.display = 'none';\n            (card as HTMLElement).style.border = '1px solid rgba(255, 255, 255, 0.1)';\n            (card as HTMLElement).style.background = `linear-gradient(145deg, var(--card-base), var(--card-dark))`;\n          }\n        });\n\n        if (count === 0) {\n          label.innerText = '未选择任何项目';\n          applyBtn.disabled = true;\n          applyBtn.style.background = 'linear-gradient(135deg, #2E7D32, #1B5E20)';\n          applyBtn.style.opacity = '0.4';\n          applyBtn.style.cursor = 'not-allowed';\n        } else {\n          const lastName = lastClickedKey ? ` | 当前: ${lastClickedKey}` : '';\n          label.innerText = multiSelect ? `已选中 ${count} 个项目${lastName}` : `已选择: ${lastClickedKey}`;\n          applyBtn.disabled = false;\n          applyBtn.style.background = 'linear-gradient(135deg, #43A047, #2E7D32)';\n          applyBtn.style.opacity = '1';\n          applyBtn.style.cursor = 'pointer';\n        }\n      };\n\n      const loadDetails = async (key: string, meta: any) => {\n        detailContainer.innerHTML = detailRenderer(key, meta);\n        previewContent.innerText = '正在加载内容...';\n        try {\n          const res = await fetch(`${previewUrlBase}${key}${previewExt}`, { cache: 'no-cache' });\n          previewContent.innerText = res.ok ? await res.text() : `无法加载: ${res.status}`;\n        } catch (e: any) {\n          previewContent.innerText = `错误: ${e.message}`;\n        }\n      };\n\n      gridWrapper.addEventListener('click', async e => {\n        const card = (e.target as HTMLElement).closest('.fate-card') as HTMLElement;\n        if (!card) return;\n        const key = card.dataset.key || '';\n        const rawMeta = card.dataset.meta;\n\n        try {\n          const meta = JSON.parse(decodeURIComponent(rawMeta || '{}'));\n          if (multiSelect) {\n            if (selectedKeysSet.has(key)) selectedKeysSet.delete(key);\n            else selectedKeysSet.add(key);\n          } else {\n            selectedKeysSet.clear();\n            selectedKeysSet.add(key);\n          }\n          lastClickedKey = key;\n          refreshUI();\n          await loadDetails(key, meta);\n        } catch (err) {\n          console.error(err);\n        }\n      });\n\n      applyBtn.onclick = async () => {\n        if (selectedKeysSet.size === 0) return;\n        const keys = Array.from(selectedKeysSet);\n        if (onApply) {\n          closeModal();\n          await onApply(keys, catalog);\n        }\n      };\n\n      refreshUI();\n    });\n  };\n\n  const createViewToggler = (\n    gridWrapper: HTMLElement,\n    previewWrapper: HTMLElement,\n    mainContainer: HTMLElement,\n    toggleBtn: HTMLButtonElement,\n  ) => {\n    let isSplit = false;\n    return () => {\n      isSplit = !isSplit;\n      if (isSplit) {\n        gridWrapper.style.flex = '0 0 40%';\n        gridWrapper.style.minWidth = '120px';\n        gridWrapper.style.maxWidth = '250px';\n        previewWrapper.style.display = 'flex';\n        mainContainer.classList.add('fate-sys-mode-split');\n        toggleBtn.innerHTML = '<i class=\"fas fa-th\"></i>';\n      } else {\n        gridWrapper.style.flex = '1';\n        gridWrapper.style.minWidth = '0';\n        gridWrapper.style.maxWidth = 'none';\n        previewWrapper.style.display = 'none';\n        mainContainer.classList.remove('fate-sys-mode-split');\n        toggleBtn.innerHTML = '<i class=\"fas fa-th-large\"></i>';\n      }\n    };\n  };\n\n  // ==================== 目录获取通用函数 ====================\n  const fetchCatalog = async (url: string, sortFn?: (a: any, b: any) => number) => {\n    toastr.info('加载目录...', '', { timeOut: 0 });\n    try {\n      const res = await fetch(url, { cache: 'no-cache' });\n      if (!res.ok) throw new Error(`目录下载失败: ${res.status}`);\n      const catalog = await res.json();\n      toastr.clear();\n      const list = Object.keys(catalog).map(key => ({ key, ...catalog[key] }));\n      if (sortFn) list.sort(sortFn);\n      return { list, catalog };\n    } catch (e: any) {\n      toastr.clear();\n      toastr.error(`加载失败: ${e.message}`);\n      throw e;\n    }\n  };\n\n  // ==================== 世界书获取（角色绑定） ====================\n  /**\n   * 获取当前角色绑定的世界书\n   * @param type 'current' 优先获取角色绑定世界书，'global' 获取全局世界书\n   * @throws 如果没有找到世界书则抛出错误\n   */\n  const getCurrentWorldbook = (type: 'current' | 'global'): { primary: string; secondary: string[] } => {\n    // 使用酒馆助手提供的接口直接获取角色绑定的世界书\n    const charWorldbooks = getCharWorldbookNames('current');\n    if (!charWorldbooks) {\n      throw new Error('未找到任何世界书，请先在酒馆中创建世界书');\n    }\n\n    if (type === 'global') {\n      const globalWbs = getGlobalWorldbookNames();\n      if (!globalWbs || globalWbs.length === 0) {\n        throw new Error('未找到任何全局世界书，请先在酒馆中创建世界书');\n      }\n      return { primary: globalWbs[0], secondary: globalWbs.slice(1) };\n    }\n\n    // current 类型：必须使用角色绑定的世界书\n    if (!charWorldbooks.primary) {\n      throw new Error('当前角色卡未绑定世界书，请先在角色卡设置中绑定一个世界书');\n    }\n\n    return {\n      primary: charWorldbooks.primary,\n      secondary: (charWorldbooks as any).additional || [],\n    };\n  };\n\n  // ==================== 设置面板 ====================\n  const openSystemUpdaterSettings = (): void => {\n    let targetDoc = document;\n    try {\n      if (window.top?.document) targetDoc = window.top.document;\n    } catch (e) {\n      // cross-origin\n    }\n\n    const modalOverlay = targetDoc.getElementById('custom-system-modal');\n    if (!modalOverlay) return;\n\n    const existing = targetDoc.getElementById('sys-updater-settings-overlay');\n    if (existing) existing.remove();\n\n    const settingsOverlay = targetDoc.createElement('div');\n    settingsOverlay.id = 'sys-updater-settings-overlay';\n    Object.assign(settingsOverlay.style, {\n      position: 'absolute',\n      top: '0',\n      left: '0',\n      width: '100%',\n      height: '100%',\n      backgroundColor: 'rgba(0,0,0,0.6)',\n      zIndex: '200',\n      display: 'flex',\n      justifyContent: 'center',\n      alignItems: 'center',\n      backdropFilter: 'blur(2px)',\n    });\n    settingsOverlay.onclick = e => e.stopPropagation();\n\n    const currentConfig = getConfig();\n    const settingsBox = targetDoc.createElement('div');\n    Object.assign(settingsBox.style, {\n      backgroundColor: '#263238',\n      color: '#ECEFF1',\n      padding: '20px',\n      borderRadius: '16px',\n      minWidth: '320px',\n      maxWidth: '90%',\n    });\n\n    let themeOptionsHtml = '';\n    Object.entries(PRESET_THEMES).forEach(([key, theme]) => {\n      const isActive = currentConfig.bgColor === theme.bgColor ? 'checked' : '';\n      themeOptionsHtml += `\n        <label style=\"display:flex; align-items:center; gap:10px; margin:8px 0; cursor:pointer;\">\n          <input type=\"radio\" name=\"theme\" value=\"${key}\" ${isActive}>\n          <span>${theme.name}</span>\n        </label>\n      `;\n    });\n\n    settingsBox.innerHTML = `\n      <h3 style=\"margin-top:0; display:flex; align-items:center; gap:8px;\">\n        <i class=\"fas fa-cog\"></i> 界面设置\n      </h3>\n      <div style=\"margin:16px 0;\">\n        <label style=\"display:block; margin-bottom:8px; opacity:0.8;\">选择主题</label>\n        ${themeOptionsHtml}\n      </div>\n      <div style=\"margin:16px 0;\">\n        <label style=\"display:block; margin-bottom:8px; opacity:0.8;\">窗口宽度</label>\n        <input type=\"range\" id=\"settings-width\" min=\"600\" max=\"1400\" value=\"${currentConfig.width}\"\n               style=\"width:100%; accent-color:#4CAF50;\">\n        <div style=\"text-align:right; font-size:0.8em; opacity:0.7;\" id=\"width-display\">${currentConfig.width}px</div>\n      </div>\n      <div style=\"margin:16px 0;\">\n        <label style=\"display:block; margin-bottom:8px; opacity:0.8;\">窗口高度</label>\n        <input type=\"range\" id=\"settings-height\" min=\"40\" max=\"95\" value=\"${currentConfig.height}\"\n               style=\"width:100%; accent-color:#4CAF50;\">\n        <div style=\"text-align:right; font-size:0.8em; opacity:0.7;\" id=\"height-display\">${currentConfig.height}%</div>\n      </div>\n      <div style=\"display:flex; gap:12px; justify-content:flex-end; margin-top:20px;\">\n        <button id=\"settings-cancel\" style=\"\n          padding:8px 20px; border-radius:20px; border:1px solid rgba(255,255,255,0.3);\n          background:transparent; color:#ECEFF1; cursor:pointer;\">取消\n        </button>\n        <button id=\"settings-save\" style=\"\n          padding:8px 20px; border-radius:20px; border:none;\n          background:linear-gradient(135deg, #43A047, #2E7D32); color:white; cursor:pointer;\">保存\n        </button>\n      </div>\n    `;\n\n    settingsOverlay.appendChild(settingsBox);\n    modalOverlay.appendChild(settingsOverlay);\n\n    const widthInput = settingsBox.querySelector('#settings-width') as HTMLInputElement;\n    const heightInput = settingsBox.querySelector('#settings-height') as HTMLInputElement;\n    const widthDisplay = settingsBox.querySelector('#width-display') as HTMLElement;\n    const heightDisplay = settingsBox.querySelector('#height-display') as HTMLElement;\n\n    widthInput.oninput = () => {\n      widthDisplay.innerText = widthInput.value + 'px';\n    };\n    heightInput.oninput = () => {\n      heightDisplay.innerText = heightInput.value + '%';\n    };\n\n    const cancelBtn = settingsBox.querySelector('#settings-cancel') as HTMLButtonElement;\n    const saveBtn = settingsBox.querySelector('#settings-save') as HTMLButtonElement;\n\n    cancelBtn.onclick = () => settingsOverlay.remove();\n    saveBtn.onclick = () => {\n      const selectedTheme = (settingsBox.querySelector('input[name=\"theme\"]:checked') as HTMLInputElement)?.value;\n      if (selectedTheme && PRESET_THEMES[selectedTheme as keyof typeof PRESET_THEMES]) {\n        const theme = PRESET_THEMES[selectedTheme as keyof typeof PRESET_THEMES];\n        currentConfig.bgColor = theme.bgColor;\n        currentConfig.cardColor = theme.cardColor;\n        currentConfig.textColor = theme.textColor;\n      }\n      currentConfig.width = parseInt(widthInput.value);\n      currentConfig.height = parseInt(heightInput.value);\n      saveConfig(currentConfig);\n      settingsOverlay.remove();\n      reloadCurrentPanel();\n    };\n  };\n\n  const reloadCurrentPanel = (): void => {\n    const targetDoc = window.top?.document || document;\n    const modalContent = targetDoc.querySelector('#custom-system-modal > div.fate-modal-content') as HTMLElement;\n    if (!modalContent) return;\n\n    if (modalContent.querySelector('.system-card')) {\n      executeUpdate('', { fromMain: true });\n    } else if (modalContent.querySelector('.role-card')) {\n      executeCharacterUpdate('', { fromMain: true });\n    } else if (modalContent.querySelector('.race-card')) {\n      executeRaceUpdate('', { fromMain: true });\n    } else if (modalContent.querySelector('.module-card')) {\n      openMainPanel();\n    }\n  };\n\n  // ==================== 系统模块 ====================\n  const executeUpdate = async (param: string, options = { fromMain: false }) => {\n    const { fromMain = false } = options;\n\n    if (!param) {\n      await createSelectorModal({\n        title: '命定系统 · 选择面板',\n        icon: 'fas fa-cubes',\n        searchPlaceholder: '🔍 搜索系统名称、作者...',\n        catalogUrl: CATALOG_URL,\n        sortFn: (a, b) => {\n          const dateA = a.updateTime === '未知' ? '1970-01-01' : a.updateTime;\n          const dateB = b.updateTime === '未知' ? '1970-01-01' : b.updateTime;\n          return dateB.localeCompare(dateA); // 从新到旧\n        },\n        previewUrlBase: CDN_BASE + '/system/',\n        fromMain,\n        multiSelect: false,\n        cardRenderer: (sys, ctx) => {\n          const { author = '未知', updateTime = '未知', description = '暂无简介', systemName = sys.key } = sys;\n          const meta = encodeURIComponent(JSON.stringify({ author, updateTime, description, systemName }));\n          const searchStr = `${sys.key} ${author} ${updateTime} ${description}`.toLowerCase();\n          return `\n            <div class=\"fate-card system-card\" data-search=\"${searchStr}\" data-key=\"${sys.key}\" data-meta=\"${meta}\"\n                 style=\"background: linear-gradient(145deg, ${ctx.cardBase}, ${ctx.cardDark});\">\n              <div class=\"fate-card-title\">${sys.key}</div>\n              <div class=\"fate-card-sep\"></div>\n              <div class=\"fate-card-info\">\n                <div class=\"fate-info-row\"><span style=\"opacity:0.7;\">作者</span><span class=\"fate-info-value\">${author}</span></div>\n                <div class=\"fate-info-row\"><span style=\"opacity:0.7;\">更新</span><span class=\"fate-info-value\">${updateTime}</span></div>\n              </div>\n              <div class=\"fate-selected-indicator\"><i class=\"fas fa-check-circle\"></i></div>\n            </div>\n          `;\n        },\n        detailRenderer: (key, meta) => {\n          const desc = meta.description || '暂无简介';\n          return `\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">系统名称</span><span class=\"fate-detail-value\">${key}</span></div>\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">作者</span><span class=\"fate-detail-value\">${meta.author}</span></div>\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">更新日期</span><span class=\"fate-detail-value\">${meta.updateTime}</span></div>\n            <div class=\"fate-detail-item\" style=\"border-bottom:none; flex-direction:column; align-items:flex-start;\">\n              <div class=\"fate-detail-label\" style=\"margin-bottom:5px;\">简介</div>\n              <div style=\"opacity:0.9; line-height:1.4; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px; width:100%;\">${desc}</div>\n            </div>\n          `;\n        },\n        onApply: async (keys, catalog) => {\n          await deploySystemContent(keys[0], catalog?.[keys[0]]);\n        },\n      });\n    }\n  };\n\n  // ==================== 通用部署模块 ====================\n  /**\n   * 通用世界书条目部署函数\n   * 检测是否有同名条目，有则覆盖，无则新增\n   * @param worldbookName 世界书名称\n   * @param entryName 条目名称\n   * @param entryConfig 条目配置\n   * @param content 条目内容\n   */\n  const deployWorldbookEntry = async (\n    worldbookName: string,\n    entryName: string,\n    entryConfig: Record<string, any>,\n    content: string,\n  ): Promise<void> => {\n    await updateWorldbookWith(worldbookName, (entries: any[]) => {\n      // 检测是否有同名条目，有则覆盖，无则新增\n      const existingIndex = entries.findIndex(e => (e.name || e.comment || '') === entryName);\n\n      if (existingIndex !== -1) {\n        // 存在同名条目，覆盖它\n        entries[existingIndex] = {\n          ...entries[existingIndex],\n          content,\n          ...entryConfig,\n          uid: entries[existingIndex].uid,\n          enabled: true,\n        };\n      } else {\n        // 不存在，新增条目\n        const newEntry = { content, ...entryConfig };\n        if ('uid' in newEntry) delete (newEntry as any).uid;\n        entries.push(newEntry);\n      }\n      return entries;\n    });\n  };\n\n  const deploySystemContent = async (systemKey: string, systemConfig?: any): Promise<void> => {\n    try {\n      toastr.info('正在同步系统配置...', '', { timeOut: 0 });\n\n      // 如果没有传入系统配置，从目录中获取\n      if (!systemConfig) {\n        try {\n          const catRes = await fetch(CATALOG_URL, { cache: 'no-cache' });\n          const catalog = await catRes.json();\n          if (catalog[systemKey]) systemConfig = catalog[systemKey];\n        } catch (e) {\n          // 忽略错误，使用默认值\n        }\n      }\n\n      // 获取系统内容\n      const contentRes = await fetch(`${CDN_BASE}/system/${systemKey}.txt`, { cache: 'no-cache' });\n      if (!contentRes.ok) throw new Error(`无法获取系统内容 (${contentRes.status})`);\n      const textContent = await contentRes.text();\n\n      const status = {\n        wb: { success: false, msg: '' },\n      };\n\n      // 部署世界书\n      const worldbook = getCurrentWorldbook('current');\n      const authorName = systemConfig?.author || '未知';\n      const targetWbName = `命定系统-${systemKey}${WB_SEARCH_MARKER}(${authorName})`;\n      const config = {\n        name: targetWbName,\n        comment: targetWbName,\n        enabled: true,\n        strategy: { type: 'constant' },\n        position: { type: 'at_depth', depth: 1, order: 1100 },\n        recursion: { prevent_outgoing: true },\n      };\n\n      // 使用通用部署函数\n      await deployWorldbookEntry(worldbook.primary, targetWbName, config, textContent);\n      status.wb = { success: true, msg: '更新完成' };\n\n      toastr.clear();\n      const type = status.wb.success ? 'success' : 'error';\n      const report = `系统: ${systemKey}\\n世界书: ${status.wb.msg}`;\n      toastr[type](report, '同步结束', { timeOut: 5000 });\n    } catch (globalErr: any) {\n      toastr.error(globalErr.message, '脚本错误');\n    }\n  };\n\n  // ==================== 角色模块 ====================\n  const generateCharacterEntryName = (charName: string, author: string, description: string) => {\n    const cleanDesc = description.replace(/\\s+/g, ' ').trim();\n    const shortDesc = cleanDesc.length > 50 ? cleanDesc.substring(0, 50) + '…' : cleanDesc;\n    return `[角色]${charName}${WB_SEARCH_MARKER}(${author}-${shortDesc})`;\n  };\n\n  const deployCharacterEntry = async (characterKey: string, characterConfig: any, worldbookName: string) => {\n    const { author = '未知', description = '暂无简介', keywords = [], keywords_secondary = [] } = characterConfig;\n\n    const safeKeywords = Array.isArray(keywords) ? keywords : keywords ? [String(keywords)] : [];\n    const safeKeywordsSecondary = Array.isArray(keywords_secondary)\n      ? keywords_secondary\n      : keywords_secondary\n        ? [String(keywords_secondary)]\n        : [];\n\n    const entryName = generateCharacterEntryName(characterKey, author, description);\n\n    const contentRes = await fetch(`${CHARACTER_CONTENT_BASE}${characterKey}.txt`, { cache: 'no-cache' });\n    if (!contentRes.ok) throw new Error(`无法获取角色内容 (${contentRes.status})`);\n    const content = await contentRes.text();\n\n    const entryConfig = {\n      name: entryName,\n      enabled: true,\n      use_group_scoring: false,\n      strategy: {\n        type: 'selective' as const,\n        keys: safeKeywords,\n        keys_secondary: { logic: 'and_any', keys: safeKeywordsSecondary },\n      },\n      position: { type: 'after_character_definition' as const, order: 601 },\n      recursion: { prevent_incoming: true, prevent_outgoing: true },\n    };\n\n    // 使用通用部署函数\n    await deployWorldbookEntry(worldbookName, entryName, entryConfig, content);\n  };\n\n  const deployMultipleCharacterEntries = async (selectedKeys: string[], characterCatalog: Record<string, any>) => {\n    const worldbook = getCurrentWorldbook('current');\n    const wbName = worldbook.primary;\n\n    let successCount = 0;\n    let failCount = 0;\n    const errors: string[] = [];\n\n    await Promise.allSettled(\n      selectedKeys.map(async key => {\n        try {\n          const config = characterCatalog[key];\n          if (!config) throw new Error('角色信息缺失');\n          await deployCharacterEntry(key, config, wbName);\n          successCount++;\n        } catch (e: any) {\n          failCount++;\n          errors.push(`${key}: ${e.message}`);\n        }\n      }),\n    );\n\n    return { successCount, failCount, errors };\n  };\n\n  const executeCharacterUpdate = async (param: string, options = { fromMain: false }) => {\n    const { fromMain = false } = options;\n    if (!param) {\n      await createSelectorModal({\n        title: '命定角色 · 选择面板',\n        icon: 'fas fa-users',\n        searchPlaceholder: '🔍 搜索角色、作者...',\n        catalogUrl: CHARACTER_CATALOG_URL,\n        sortFn: (a, b) => {\n          const dateA = a.updateTime === '未知' ? '1970-01-01' : a.updateTime;\n          const dateB = b.updateTime === '未知' ? '1970-01-01' : b.updateTime;\n          return dateB.localeCompare(dateA); // 从新到旧\n        },\n        previewUrlBase: CHARACTER_CONTENT_BASE,\n        fromMain,\n        multiSelect: true,\n        catalogProcessor: catalog => {\n          Object.keys(catalog).forEach(key => {\n            const item = catalog[key];\n            if (typeof item.keywords === 'string') {\n              item.keywords = item.keywords\n                .split(',')\n                .map((s: string) => s.trim())\n                .filter(Boolean);\n            }\n            if (!Array.isArray(item.keywords)) item.keywords = [];\n            if (typeof item.keywords_secondary === 'string') {\n              item.keywords_secondary = item.keywords_secondary\n                .split(',')\n                .map((s: string) => s.trim())\n                .filter(Boolean);\n            }\n            if (!Array.isArray(item.keywords_secondary)) item.keywords_secondary = [];\n          });\n        },\n        cardRenderer: (char, ctx) => {\n          const {\n            author = '未知',\n            updateTime = '未知',\n            description = '暂无简介',\n            keywords = [],\n            keywords_secondary = [],\n          } = char;\n          const meta = encodeURIComponent(\n            JSON.stringify({\n              author,\n              updateTime,\n              description,\n              keywords,\n              keywordsSecondary: keywords_secondary,\n            }),\n          );\n          const searchStr = `${char.key} ${author} ${updateTime} ${description}`.toLowerCase();\n\n          return `\n            <div class=\"fate-card role-card\" data-search=\"${searchStr}\" data-key=\"${char.key}\" data-meta=\"${meta}\"\n                 style=\"background: linear-gradient(145deg, ${ctx.cardBase}, ${ctx.cardDark});\">\n              <div class=\"fate-card-title\">${char.key}</div>\n              <div class=\"fate-card-sep\"></div>\n              <div class=\"fate-card-info\">\n                <div class=\"fate-info-row\"><span style=\"opacity:0.7;\">作者</span><span class=\"fate-info-value\">${author}</span></div>\n                <div class=\"fate-info-row\"><span style=\"opacity:0.7;\">更新</span><span class=\"fate-info-value\">${updateTime}</span></div>\n              </div>\n              <div class=\"fate-selected-indicator\"><i class=\"fas fa-check-circle\"></i></div>\n            </div>\n          `;\n        },\n        detailRenderer: (key, meta) => {\n          let keywordsHtml = '';\n          if (meta.keywords?.length)\n            keywordsHtml += `<div class=\"fate-detail-item\"><span class=\"fate-detail-label\">主要关键词</span><span class=\"fate-detail-value\">${meta.keywords.join(', ')}</span></div>`;\n          if (meta.keywordsSecondary?.length)\n            keywordsHtml += `<div class=\"fate-detail-item\"><span class=\"fate-detail-label\">次要关键词</span><span class=\"fate-detail-value\">${meta.keywordsSecondary.join(', ')}</span></div>`;\n\n          const desc = meta.description || '暂无简介';\n          return `\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">角色名称</span><span class=\"fate-detail-value\">${key}</span></div>\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">作者</span><span class=\"fate-detail-value\">${meta.author}</span></div>\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">更新日期</span><span class=\"fate-detail-value\">${meta.updateTime}</span></div>\n            ${keywordsHtml}\n            <div class=\"fate-detail-item\" style=\"border-bottom:none; flex-direction:column; align-items:flex-start;\">\n              <div class=\"fate-detail-label\" style=\"margin-bottom:5px;\">简介</div>\n              <div style=\"opacity:0.9; line-height:1.4; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px; width:100%;\">${desc}</div>\n            </div>\n          `;\n        },\n        onApply: async (keys, catalog) => {\n          try {\n            toastr.info(`正在同步 ${keys.length} 个角色...`, '', { timeOut: 0 });\n            const result = await deployMultipleCharacterEntries(keys, catalog);\n            toastr.clear();\n            if (result.errors.length > 0) {\n              toastr.warning(\n                `同步完成: 成功 ${result.successCount}, 失败 ${result.failCount}\\n错误详情: ${result.errors.join('; ')}`,\n                '角色同步',\n                { timeOut: 8000 },\n              );\n            } else {\n              toastr.success(`成功同步 ${result.successCount} 个角色条目`, '角色同步完成');\n            }\n          } catch (e: any) {\n            toastr.error(`同步失败: ${e.message}`);\n          }\n        },\n      });\n    }\n  };\n\n  // ==================== 种族模块 ====================\n  const generateRaceEntryName = (raceName: string, author: string, description: string) => {\n    const cleanDesc = description.replace(/\\s+/g, ' ').trim();\n    const shortDesc = cleanDesc.length > 50 ? cleanDesc.substring(0, 50) + '…' : cleanDesc;\n    return `[扩展][${raceName}]种族-${raceName}${WB_SEARCH_MARKER}(${author}-${shortDesc})`;\n  };\n\n  const deployRaceEntry = async (raceKey: string, raceConfig: any, worldbookName: string, summary?: string) => {\n    const { author = '未知', description = '暂无简介', keywords = [] } = raceConfig;\n\n    const safeKeywords = Array.isArray(keywords) ? keywords : keywords ? [String(keywords)] : [];\n\n    const entryName = generateRaceEntryName(raceKey, author, description);\n\n    const contentRes = await fetch(`${RACE_CONTENT_BASE}${raceKey}.txt`, { cache: 'no-cache' });\n    if (!contentRes.ok) throw new Error(`无法获取种族内容 (${contentRes.status})`);\n    let content = await contentRes.text();\n\n    if (summary) {\n      content = content.replace(/\\s*$/, '');\n      content += '\\n' + `{{setvar::${raceKey}::${summary}}}`;\n    }\n\n    const entryConfig = {\n      name: entryName,\n      enabled: true,\n      use_group_scoring: false,\n      strategy: {\n        type: 'selective' as const,\n        keys: safeKeywords,\n      },\n      position: { type: 'before_character_definition' as const, order: 14 },\n      recursion: { prevent_incoming: true, prevent_outgoing: true },\n    };\n\n    // 使用通用部署函数\n    await deployWorldbookEntry(worldbookName, entryName, entryConfig, content);\n  };\n\n  const updateRaceOverview = async (worldbookName: string, deployedRaces: { key: string }[]) => {\n    await updateWorldbookWith(worldbookName, (entries: any[]) => {\n      const overviewEntry = entries.find(e => e.name === RACE_OVERVIEW_ENTRY_NAME);\n      if (overviewEntry) {\n        let content = overviewEntry.content || '';\n        const lines = content.split('\\n');\n        const existingGetvars = new Set<string>();\n        lines.forEach((line: string) => {\n          const match = line.match(/\\{\\{getvar::([^}]+)\\}\\}/);\n          if (match) existingGetvars.add(match[1]);\n        });\n        let modified = false;\n        deployedRaces.forEach(({ key }) => {\n          if (!existingGetvars.has(key)) {\n            content += `\\n{{getvar::${key}}}`;\n            modified = true;\n          }\n        });\n        if (modified) {\n          overviewEntry.content = content;\n        }\n      }\n      return entries;\n    });\n  };\n\n  const deployMultipleRaceEntries = async (selectedKeys: string[], raceCatalog: Record<string, any>) => {\n    const worldbook = getCurrentWorldbook('current');\n    const wbName = worldbook.primary;\n\n    let successCount = 0;\n    let failCount = 0;\n    const errors: string[] = [];\n    const deployedRaces: { key: string }[] = [];\n\n    await Promise.allSettled(\n      selectedKeys.map(async key => {\n        try {\n          const config = raceCatalog[key];\n          if (!config) throw new Error('种族信息缺失');\n          await deployRaceEntry(key, config, wbName);\n          deployedRaces.push({ key });\n          successCount++;\n        } catch (e: any) {\n          failCount++;\n          errors.push(`${key}: ${e.message}`);\n        }\n      }),\n    );\n\n    if (deployedRaces.length > 0) {\n      try {\n        await updateRaceOverview(wbName, deployedRaces);\n      } catch (e: any) {\n        console.error('更新种族概览失败:', e);\n      }\n    }\n\n    return { successCount, failCount, errors };\n  };\n\n  const executeRaceUpdate = async (param: string, options = { fromMain: false }) => {\n    const { fromMain = false } = options;\n    if (!param) {\n      await createSelectorModal({\n        title: '命定种族 · 选择面板',\n        icon: 'fas fa-dragon',\n        searchPlaceholder: '🔍 搜索种族、作者...',\n        catalogUrl: RACE_CATALOG_URL,\n        sortFn: (a, b) => {\n          const dateA = a.updateTime === '未知' ? '1970-01-01' : a.updateTime;\n          const dateB = b.updateTime === '未知' ? '1970-01-01' : b.updateTime;\n          return dateB.localeCompare(dateA); // 从新到旧\n        },\n        previewUrlBase: RACE_CONTENT_BASE,\n        fromMain,\n        multiSelect: true,\n        catalogProcessor: catalog => {\n          Object.keys(catalog).forEach(key => {\n            const item = catalog[key];\n            if (typeof item.keywords === 'string') {\n              item.keywords = item.keywords\n                .split(',')\n                .map((s: string) => s.trim())\n                .filter(Boolean);\n            }\n            if (!Array.isArray(item.keywords)) item.keywords = [];\n          });\n        },\n        cardRenderer: (race, ctx) => {\n          const { author = '未知', updateTime = '未知', description = '暂无简介', keywords = [] } = race;\n          const meta = encodeURIComponent(JSON.stringify({ author, updateTime, description, keywords }));\n          const searchStr = `${race.key} ${author} ${updateTime} ${description}`.toLowerCase();\n\n          return `\n            <div class=\"fate-card race-card\" data-search=\"${searchStr}\" data-key=\"${race.key}\" data-meta=\"${meta}\"\n                 style=\"background: linear-gradient(145deg, ${ctx.cardBase}, ${ctx.cardDark});\">\n              <div class=\"fate-card-title\">${race.key}</div>\n              <div class=\"fate-card-sep\"></div>\n              <div class=\"fate-card-info\">\n                <div class=\"fate-info-row\"><span style=\"opacity:0.7;\">作者</span><span class=\"fate-info-value\">${author}</span></div>\n                <div class=\"fate-info-row\"><span style=\"opacity:0.7;\">更新</span><span class=\"fate-info-value\">${updateTime}</span></div>\n              </div>\n              <div class=\"fate-selected-indicator\"><i class=\"fas fa-check-circle\"></i></div>\n            </div>\n          `;\n        },\n        detailRenderer: (key, meta) => {\n          let keywordsHtml = '';\n          if (meta.keywords?.length)\n            keywordsHtml += `<div class=\"fate-detail-item\"><span class=\"fate-detail-label\">关键词</span><span class=\"fate-detail-value\">${meta.keywords.join(', ')}</span></div>`;\n\n          const desc = meta.description || '暂无简介';\n          return `\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">种族名称</span><span class=\"fate-detail-value\">${key}</span></div>\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">作者</span><span class=\"fate-detail-value\">${meta.author}</span></div>\n            <div class=\"fate-detail-item\"><span class=\"fate-detail-label\">更新日期</span><span class=\"fate-detail-value\">${meta.updateTime}</span></div>\n            ${keywordsHtml}\n            <div class=\"fate-detail-item\" style=\"border-bottom:none; flex-direction:column; align-items:flex-start;\">\n              <div class=\"fate-detail-label\" style=\"margin-bottom:5px;\">简介</div>\n              <div style=\"opacity:0.9; line-height:1.4; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px; width:100%;\">${desc}</div>\n            </div>\n          `;\n        },\n        onApply: async (keys, catalog) => {\n          try {\n            toastr.info(`正在同步 ${keys.length} 个种族...`, '', { timeOut: 0 });\n            const result = await deployMultipleRaceEntries(keys, catalog);\n            toastr.clear();\n            if (result.errors.length > 0) {\n              toastr.warning(\n                `同步完成: 成功 ${result.successCount}, 失败 ${result.failCount}\\n错误详情: ${result.errors.join('; ')}`,\n                '种族同步',\n                { timeOut: 8000 },\n              );\n            } else {\n              toastr.success(`成功同步 ${result.successCount} 个种族条目`, '种族同步完成');\n            }\n          } catch (e: any) {\n            toastr.error(`同步失败: ${e.message}`);\n          }\n        },\n      });\n    }\n  };\n\n  // ==================== 主菜单 ====================\n  const MODULES = [\n    {\n      id: 'system',\n      name: '系统',\n      desc: '同步命定系统配置（世界书）',\n      color: '#1565C0',\n      action: () => executeUpdate('', { fromMain: true }),\n    },\n    {\n      id: 'character',\n      name: '角色',\n      desc: '批量部署角色世界书条目（多选）',\n      color: '#2E7D32',\n      action: () => executeCharacterUpdate('', { fromMain: true }),\n    },\n    {\n      id: 'race',\n      name: '种族',\n      desc: '批量部署种族世界书条目（多选）',\n      color: '#7B1FA2',\n      action: () => executeRaceUpdate('', { fromMain: true }),\n    },\n  ];\n\n  const openMainPanel = () => {\n    const config = getConfig();\n    let cardsHtml = '';\n    MODULES.forEach(mod => {\n      cardsHtml += `\n        <div class=\"module-card\" data-module=\"${mod.id}\" style=\"cursor:pointer; padding:20px; background:linear-gradient(145deg, ${mod.color}, ${adjustColor(mod.color, -20)});\n                border:1px solid rgba(255,255,255,0.2); border-radius:24px; display:flex; flex-direction:column;\n                box-shadow:0 8px 16px rgba(0,0,0,0.3); transition: all 0.2s ease; color:#fff;\">\n          <div style=\"font-size:1.4em; font-weight:600; margin-bottom:12px;\"><i class=\"fas fa-${mod.id === 'system' ? 'cubes' : mod.id === 'character' ? 'user-tie' : 'dragon'}\"></i> ${mod.name}</div>\n          <div style=\"font-size:0.9em; opacity:0.9; line-height:1.5;\">${mod.desc}</div>\n        </div>\n      `;\n    });\n\n    const html = `\n      <div class=\"fate-header\">\n        <h3><i class=\"fas fa-tools\" style=\"margin-right:10px;\"></i>命定创意工坊 · 主菜单</h3>\n        <div style=\"display:flex; gap:8px;\">\n          <button class=\"fate-icon-btn\" id=\"main-settings-btn\" title=\"界面设置\"><i class=\"fas fa-cog\"></i></button>\n        </div>\n      </div>\n      <div style=\"flex:1; display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:20px; align-content:start; padding:20px; overflow-y:auto;\">\n        ${cardsHtml}\n      </div>\n    `;\n\n    showModal(html, (doc, modalContent) => {\n      const settingsBtn = doc.getElementById('main-settings-btn');\n      if (settingsBtn) {\n        settingsBtn.onclick = e => {\n          e.stopPropagation();\n          openSystemUpdaterSettings();\n        };\n      }\n\n      doc.querySelectorAll('.module-card').forEach(card => {\n        (card as HTMLElement).onclick = () => {\n          const moduleId = (card as HTMLElement).getAttribute('data-module');\n          const mod = MODULES.find(m => m.id === moduleId);\n          if (mod) {\n            closeModal();\n            mod.action();\n          }\n        };\n      });\n    });\n  };\n\n  // ==================== 注册按钮和事件 ====================\n  replaceScriptButtons([{ name: '命定创意工坊', visible: true }]);\n\n  eventOn(getButtonEvent('命定创意工坊'), () => {\n    openMainPanel();\n  });\n\n  console.info('创意工坊脚本已加载');\n});\n"],"names":["$","CDN_BASE","CATALOG_URL","CHARACTER_CATALOG_URL","CHARACTER_CONTENT_BASE","RACE_CATALOG_URL","RACE_CONTENT_BASE","WB_SEARCH_MARKER","CONFIG_KEY","PRESET_THEMES","default","name","bgColor","cardColor","textColor","light","night","forest","cyber","DEFAULT_CONFIG","width","height","adjustColor","color","amount","hex","replace","length","split","map","c","join","num","parseInt","r","g","b","Math","max","min","toString","slice","getConfig","stored","localStorage","getItem","JSON","parse","e","closeModal","el","window","top","document","getElementById","remove","closeCustomModal","showModal","htmlContent","afterRenderCallback","targetDoc","existing","config","doc","styleId","style","createElement","id","textContent","head","appendChild","injectGlobalStyles","modalOverlay","className","Object","assign","position","left","zIndex","display","justifyContent","alignItems","paddingTop","modalContent","backgroundColor","maxWidth","maxHeight","flexDirection","cardDark","cardLight","setProperty","innerHTML","body","onclick","target","createSelectorModal","async","options","title","icon","searchPlaceholder","catalogUrl","sortFn","catalogProcessor","cardRenderer","detailRenderer","previewUrlBase","previewExt","multiSelect","onApply","fromMain","list","catalog","data","fetchCatalog","keys","key","sort","toastr","error","message","gridHtml","items","ctx","cardBase","item","renderGrid","modalIdPrefix","random","substring","ids","grid","preview","main","toggle","settings","back","search","apply","label","detail","previewContent","accordInfoHead","accordInfoBody","accordInfoArrow","accordPrevHead","accordPrevBody","accordPrevArrow","accordPrevItem","backBtn","openMainPanel","settingsBtn","stopPropagation","openSystemUpdaterSettings","gridWrapper","previewWrapper","mainContainer","toggleBtn","viewToggler","createViewToggler","headInfo","bodyInfo","arrowInfo","headPreview","bodyPreview","arrowPreview","itemPreview","toggleAccordion","isInfoOpen","isPreviewOpen","border","background","minHeight","borderBottom","padding","searchInput","oninput","term","value","toLowerCase","querySelectorAll","forEach","card","searchData","dataset","includes","focus","selectedKeysSet","Set","lastClickedKey","applyBtn","detailContainer","refreshUI","count","size","has","classList","add","indicator","querySelector","innerText","disabled","opacity","cursor","lastName","addEventListener","closest","rawMeta","meta","decodeURIComponent","delete","clear","res","fetch","cache","ok","text","status","loadDetails","err","console","Array","from","isSplit","flex","minWidth","url","info","timeOut","Error","json","getCurrentWorldbook","type","charWorldbooks","getCharWorldbookNames","globalWbs","getGlobalWorldbookNames","primary","secondary","additional","settingsOverlay","backdropFilter","currentConfig","settingsBox","borderRadius","themeOptionsHtml","entries","theme","isActive","widthInput","heightInput","widthDisplay","heightDisplay","cancelBtn","saveBtn","selectedTheme","cfg","setItem","stringify","reloadCurrentPanel","executeUpdate","executeCharacterUpdate","executeRaceUpdate","param","a","dateA","updateTime","localeCompare","sys","author","description","systemName","encodeURIComponent","desc","deploySystemContent","deployWorldbookEntry","worldbookName","entryName","entryConfig","content","updateWorldbookWith","existingIndex","findIndex","comment","uid","enabled","newEntry","push","systemKey","systemConfig","catRes","contentRes","wb","success","msg","worldbook","targetWbName","strategy","depth","order","recursion","prevent_outgoing","report","globalErr","deployCharacterEntry","characterKey","characterConfig","keywords","keywords_secondary","safeKeywords","isArray","String","safeKeywordsSecondary","charName","cleanDesc","trim","shortDesc","generateCharacterEntryName","use_group_scoring","keys_secondary","logic","prevent_incoming","s","filter","Boolean","char","keywordsSecondary","keywordsHtml","result","selectedKeys","characterCatalog","wbName","successCount","failCount","errors","Promise","allSettled","deployMultipleCharacterEntries","warning","deployRaceEntry","raceKey","raceConfig","summary","raceName","generateRaceEntryName","deployMultipleRaceEntries","raceCatalog","deployedRaces","overviewEntry","find","lines","existingGetvars","line","match","modified","updateRaceOverview","race","MODULES","action","cardsHtml","mod","moduleId","getAttribute","m","replaceScriptButtons","visible","eventOn","getButtonEvent"],"sourceRoot":""}