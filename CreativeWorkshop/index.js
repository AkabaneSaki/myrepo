$(()=>{const e='https://cdn.jsdelivr.net/gh/AkabaneSaki/myrepo@main',t=`${e}/system/catalog.json`,a=`${e}/character/catalog.json`,n=`${e}/character/`,r=`${e}/race/catalog.json`,o=`${e}/race/`,s='ï¼ˆå·¥åŠMODï¼‰',i='fate_updater_config_v2',l={default:{name:'é»˜è®¤æ·±è‰²',bgColor:'#0F172A',cardColor:'#1E293B',textColor:'#E2E8F0'},light:{name:'æ˜äº®æµ…è‰²',bgColor:'#F8FAFC',cardColor:'#FFFFFF',textColor:'#0F172A'},night:{name:'çº¯ç²¹é»‘å¤œ',bgColor:'#000000',cardColor:'#0A0A0A',textColor:'#A0A0A0'},forest:{name:'è‡ªç„¶æ£®æ—',bgColor:'#0F3B1E',cardColor:'#1B4D2A',textColor:'#E0F2E0'},cyber:{name:'èµ›åšéœ“è™¹',bgColor:'#0D0B1A',cardColor:'#2A1E4A',textColor:'#00FFFF'}},d={bgColor:'#0F172A',cardColor:'#1E293B',textColor:'#E2E8F0',width:900,height:85},c=(e,t)=>{let a=e.replace(/^#/,'');3===a.length&&(a=a.split('').map(e=>e+e).join(''));const n=parseInt(a,16);let r=(n>>16)+t,o=(n>>8&255)+t,s=(255&n)+t;return r=Math.max(0,Math.min(255,r)),o=Math.max(0,Math.min(255,o)),s=Math.max(0,Math.min(255,s)),`#${((1<<24)+(r<<16)+(o<<8)+s).toString(16).slice(1)}`},p=()=>{try{const e=localStorage.getItem(i);if(e)return{...d,...JSON.parse(e)}}catch(e){}return{...d}},y=()=>{const e=(window.top?.document||document).getElementById('custom-system-modal');e&&e.remove()};window.closeCustomModal=y;const f=(e,t)=>{let a=document;try{window.top?.document&&(a=window.top.document)}catch(e){}const n=a.getElementById('custom-system-modal');n&&n.remove();const r=p();(e=>{const t='fate-updater-styles-v3';if(e.getElementById(t))return;const a=e.createElement('style');a.id=t,a.textContent='\n      .fate-modal-overlay {\n        backdrop-filter: blur(8px);\n        background-color: rgba(0, 0, 0, 0.6);\n      }\n      .fate-modal-content {\n        background: var(--bg-color) !important;\n        color: var(--text-color);\n        border-radius: 24px;\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);\n        transition: all 0.2s ease;\n      }\n      .fate-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 16px 20px;\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n      }\n      .fate-header h3 {\n        margin: 0;\n        font-size: 1.3rem;\n        font-weight: 600;\n        color: var(--text-color);\n        letter-spacing: 0.5px;\n      }\n      .fate-icon-btn {\n        background: rgba(255, 255, 255, 0.08);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 40px;\n        width: 36px;\n        height: 36px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        color: var(--text-color);\n        font-size: 18px;\n        transition: all 0.2s;\n      }\n      .fate-icon-btn:hover {\n        background: rgba(255, 255, 255, 0.2);\n        transform: scale(1.05);\n      }\n      .fate-search {\n        margin: 0 20px 16px 20px;\n      }\n      .fate-search input {\n        width: 100%;\n        padding: 12px 20px;\n        background: rgba(0, 0, 0, 0.3);\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        border-radius: 40px;\n        color: var(--text-color);\n        font-size: 1rem;\n        outline: none;\n        transition: 0.2s;\n      }\n      .fate-search input:focus {\n        border-color: var(--highlight-color);\n        box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.2);\n      }\n      .fate-main-container {\n        flex: 1;\n        min-height: 0;\n        display: flex;\n        gap: 16px;\n        padding: 0 20px 20px 20px;\n      }\n      .fate-grid {\n        flex: 1;\n        display: grid;\n        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));\n        gap: 12px;\n        overflow-y: auto;\n        padding-right: 6px;\n        min-height: 0;\n      }\n      .fate-card {\n        background: linear-gradient(145deg, var(--card-base), var(--card-dark));\n        border: 1px solid rgba(255, 255, 255, 0.1);\n        border-radius: 20px;\n        padding: 10px 8px;\n        display: flex;\n        flex-direction: column;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        box-shadow: 0 4px 6px -2px rgba(0, 0, 0, 0.3);\n        position: relative;\n        overflow: hidden;\n        height: auto;\n        min-height: 90px;\n      }\n      .fate-card:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);\n        border-color: var(--highlight-color);\n      }\n      .fate-card.selected-card {\n        border: 2px solid var(--highlight-color);\n        background: linear-gradient(145deg, var(--card-light), var(--card-base));\n      }\n      .fate-card-title {\n        font-weight: 600;\n        font-size: 0.95rem;\n        text-align: center;\n        margin-bottom: 4px;\n        color: var(--text-color);\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      .fate-card-sep {\n        height: 1px;\n        background: rgba(255, 255, 255, 0.2);\n        margin: 2px 0 4px 0;\n      }\n      .fate-card-info {\n        font-size: 0.7rem;\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n        color: var(--text-color);\n        opacity: 0.9;\n      }\n      .fate-info-row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        flex-wrap: nowrap;\n      }\n      .fate-info-value {\n        font-weight: 600;\n        min-width: 100px;\n        text-align: right;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        white-space: nowrap;\n        margin-left: 8px;\n        flex: 1;\n      }\n      .fate-selected-indicator {\n        position: absolute;\n        bottom: 4px;\n        right: 8px;\n        color: var(--highlight-color);\n        font-size: 18px;\n        display: none;\n      }\n      .fate-preview-wrapper {\n        display: none;\n        width: 60%;\n        flex-direction: column;\n        gap: 12px;\n        overflow-y: auto;\n        padding: 0;\n        min-height: 0;\n      }\n      .fate-preview-wrapper .fate-accordion {\n        width: 100%;\n      }\n      .fate-accordion {\n        background: rgba(0, 0, 0, 0.2);\n        border-radius: 16px;\n        border: 1px solid rgba(255, 255, 255, 0.15);\n        overflow: hidden;\n        backdrop-filter: blur(4px);\n      }\n      .fate-accord-header {\n        padding: 12px 16px;\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        cursor: pointer;\n        background: rgba(255, 255, 255, 0.03);\n        border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        font-weight: 500;\n        transition: 0.2s;\n      }\n      .fate-accord-header:hover {\n        background: rgba(255, 255, 255, 0.08);\n      }\n      .fate-accord-body {\n        padding: 16px;\n        max-height: 300px;\n        overflow-y: auto;\n        transition: 0.2s;\n      }\n      .fate-detail-container {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n      }\n      .fate-detail-item {\n        display: flex;\n        border-bottom: 1px dashed rgba(255,255,255,0.1);\n        padding: 6px 0;\n      }\n      .fate-detail-label {\n        width: 80px;\n        opacity: 0.7;\n      }\n      .fate-detail-value {\n        flex: 1;\n        text-align: right;\n        font-weight: 500;\n      }\n      .fate-preview-content {\n        background: rgba(0, 0, 0, 0.3);\n        border-radius: 12px;\n        padding: 12px;\n        font-family: \'Fira Code\', monospace;\n        font-size: 12px;\n        white-space: pre-wrap;\n        max-height: 300px;\n        overflow-y: auto;\n      }\n      .fate-footer {\n        padding: 16px 20px;\n        border-top: 1px solid rgba(255,255,255,0.1);\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n      }\n      .fate-selected-label {\n        font-size: 0.9rem;\n        opacity: 0.8;\n      }\n      .fate-apply-btn {\n        background: linear-gradient(135deg, #2E7D32, #1B5E20);\n        border: none;\n        border-radius: 40px;\n        padding: 10px 28px;\n        color: white;\n        font-weight: 600;\n        cursor: pointer;\n        transition: 0.2s;\n        box-shadow: 0 4px 10px rgba(0, 80, 0, 0.4);\n      }\n      .fate-apply-btn:not(:disabled):hover {\n        transform: scale(1.02);\n        filter: brightness(1.2);\n      }\n      .fate-apply-btn:disabled {\n        opacity: 0.4;\n        cursor: not-allowed;\n      }\n      .fate-sys-mode-split .fate-grid {\n        grid-template-columns: 1fr;\n        max-width: 240px;\n      }\n      .fate-sys-mode-split .fate-card {\n        padding: 8px;\n        height: auto;\n        min-height: 40px;\n      }\n      .fate-sys-mode-split .fate-card-info {\n        display: none;\n      }\n      .fate-sys-mode-split .fate-card-title {\n        font-size: 0.85rem;\n        margin-bottom: 0;\n      }\n      .fate-sys-mode-split .fate-card-sep {\n        display: none;\n      }\n    ',e.head.appendChild(a)})(a);const o=a.createElement('div');o.id='custom-system-modal',o.className='fate-modal-overlay',Object.assign(o.style,{position:'fixed',top:'0',left:'0',width:'100%',height:'100%',zIndex:'2147483647',display:'flex',justifyContent:'center',alignItems:'flex-start',paddingTop:'60px'});const s=a.createElement('div');s.className='fate-modal-content',Object.assign(s.style,{backgroundColor:r.bgColor,maxWidth:r.width+'px',width:'95%',maxHeight:r.height+'vh',display:'flex',flexDirection:'column'});const i=c(r.cardColor,-20),l=c(r.cardColor,20);var d;s.style.setProperty('--bg-color',r.bgColor),s.style.setProperty('--card-base',r.cardColor),s.style.setProperty('--card-dark',i),s.style.setProperty('--card-light',l),s.style.setProperty('--text-color',r.textColor),s.style.setProperty('--highlight-color',(d=r.bgColor,(299*parseInt(d.slice(1,3),16)+587*parseInt(d.slice(3,5),16)+114*parseInt(d.slice(5,7),16))/1e3>155?'#FF6F00':'#FFD700')),s.innerHTML=e,o.appendChild(s),a.body.appendChild(o),o.onclick=e=>{e.target===o&&y()},t&&t(a,s)},g=async e=>{const{title:t,icon:a,searchPlaceholder:n,catalogUrl:r,sortFn:o,catalogProcessor:s,cardRenderer:i,detailRenderer:l,previewUrlBase:d,previewExt:g='.txt',multiSelect:h=!1,onApply:b,fromMain:x=!1}=e,w=p();let k=[],C={};try{const e=await u(r,o);C=e.catalog,s?(s(C),k=Object.keys(C).map(e=>({key:e,...C[e]})),o&&k.sort(o)):k=e.list}catch(e){return void toastr.error(`åŠ è½½ç›®å½•å¤±è´¥: ${e.message}`)}const E=((e,t,a)=>{const n={cardBase:t.cardColor,cardDark:c(t.cardColor,-20),textColor:t.textColor};return e.map(e=>a(e,n)).join('')})(k,w,i),B=Math.random().toString(36).substring(7),I={grid:`${B}-grid`,preview:`${B}-preview`,main:`${B}-main`,toggle:`${B}-toggle`,settings:`${B}-settings`,back:`${B}-back`,search:`${B}-search`,apply:`${B}-apply`,label:`${B}-label`,detail:`${B}-detail`,previewContent:`${B}-preview-content`,accordInfoHead:`${B}-info-head`,accordInfoBody:`${B}-info-body`,accordInfoArrow:`${B}-info-arrow`,accordPrevHead:`${B}-prev-head`,accordPrevBody:`${B}-prev-body`,accordPrevArrow:`${B}-prev-arrow`,accordPrevItem:`${B}-prev-item`};f(`\n      <div class="fate-header">\n        <h3><i class="${a}" style="margin-right:10px;"></i>${t}</h3>\n        <div style="display:flex; gap:8px;">\n          ${x?`<button class="fate-icon-btn" id="${I.back}" title="è¿”å›ä¸»èœå•"><i class="fas fa-arrow-left"></i></button>`:''}\n          <button class="fate-icon-btn" id="${I.toggle}" title="åˆ‡æ¢è§†å›¾"><i class="fas fa-th-large"></i></button>\n          <button class="fate-icon-btn" id="${I.settings}" title="ç•Œé¢è®¾ç½®"><i class="fas fa-cog"></i></button>\n        </div>\n      </div>\n      <div class="fate-search">\n        <input type="text" id="${I.search}" placeholder="${n}">\n      </div>\n      <div class="fate-main-container" id="${I.main}">\n        <div class="fate-grid" id="${I.grid}">\n          ${E}\n        </div>\n        <div class="fate-preview-wrapper" id="${I.preview}">\n          <div class="fate-accordion">\n            <div class="fate-accord-header" id="${I.accordInfoHead}">\n              <span><i class="far fa-file-alt" style="margin-right:8px;"></i>è¯¦æƒ…ä¿¡æ¯</span>\n              <i class="fas fa-chevron-down" id="${I.accordInfoArrow}"></i>\n            </div>\n            <div class="fate-accord-body" id="${I.accordInfoBody}">\n              <div id="${I.detail}" class="fate-detail-container">\n                <div style="opacity:0.5; text-align:center; padding:20px;">è¯·é€‰æ‹©å·¦ä¾§é¡¹ç›®æŸ¥çœ‹è¯¦æƒ…</div>\n              </div>\n            </div>\n          </div>\n          <div class="fate-accordion" id="${I.accordPrevItem}">\n            <div class="fate-accord-header" id="${I.accordPrevHead}">\n              <span><i class="fas fa-eye" style="margin-right:8px;"></i>å†…å®¹é¢„è§ˆ</span>\n              <i class="fas fa-chevron-right" id="${I.accordPrevArrow}"></i>\n            </div>\n            <div class="fate-accord-body" id="${I.accordPrevBody}" style="display:none;">\n              <pre id="${I.previewContent}" class="fate-preview-content"></pre>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="fate-footer">\n        <span class="fate-selected-label" id="${I.label}">æœªé€‰æ‹©ä»»ä½•é¡¹ç›®</span>\n        <button class="fate-apply-btn" id="${I.apply}" disabled>åº”ç”¨é€‰ä¸­é¡¹</button>\n      </div>\n    `,(e,t)=>{if(x){const t=e.getElementById(I.back);t&&(t.onclick=()=>{y(),F()})}const a=e.getElementById(I.settings);a&&(a.onclick=e=>{e.stopPropagation(),v()});const n=e.getElementById(I.grid),r=e.getElementById(I.preview),o=e.getElementById(I.main),s=e.getElementById(I.toggle),i=m(n,r,o,s);s.onclick=i;const c=e.getElementById(I.accordInfoHead),p=e.getElementById(I.accordInfoBody),f=e.getElementById(I.accordInfoArrow),u=e.getElementById(I.accordPrevHead),w=e.getElementById(I.accordPrevBody),k=e.getElementById(I.accordPrevArrow),E=e.getElementById(I.accordPrevItem),B=e=>{const t='none'!==p.style.display,a='none'!==w.style.display;'info'===e?t?(p.style.display='none',f.className='fas fa-chevron-right'):(p.style.display='block',f.className='fas fa-chevron-down',w.style.display='none',k.className='fas fa-chevron-right',E.style.border='',E.style.background='',E.style.minHeight='',u.style.borderBottom='',w.style.border='',w.style.padding=''):a?(w.style.display='none',k.className='fas fa-chevron-right',E.style.border='',E.style.background='',E.style.minHeight='',u.style.borderBottom='',w.style.border='',w.style.padding=''):(p.style.display='none',f.className='fas fa-chevron-right',w.style.display='flex',k.className='fas fa-chevron-down',E.style.border='1px solid rgba(255,255,255,0.2)',E.style.background='rgba(0,0,0,0.1)',E.style.minHeight='200px',u.style.borderBottom='1px solid rgba(255,255,255,0.1)',w.style.border='none',w.style.padding='0')};c.onclick=()=>B('info'),u.onclick=()=>B('preview');const A=e.getElementById(I.search);A.oninput=e=>{const t=e.target.value.toLowerCase();n.querySelectorAll('.fate-card').forEach(e=>{const a=e.dataset.search||'';e.style.display=a.includes(t)?'flex':'none'})},A.focus();const S=new Set;let T=null;const j=e.getElementById(I.apply),M=e.getElementById(I.label),P=e.getElementById(I.detail),O=e.getElementById(I.previewContent),N=()=>{const e=S.size;if(n.querySelectorAll('.fate-card').forEach(e=>{const t=e.dataset.key;if(S.has(t||'')){e.classList.add('selected-card');const t=e.querySelector('.fate-selected-indicator');t&&(t.style.display='block'),e.style.border='2px solid var(--highlight-color)',e.style.background='linear-gradient(145deg, var(--card-light), var(--card-base))'}else{e.classList.remove('selected-card');const t=e.querySelector('.fate-selected-indicator');t&&(t.style.display='none'),e.style.border='1px solid rgba(255, 255, 255, 0.1)',e.style.background='linear-gradient(145deg, var(--card-base), var(--card-dark))'}}),0===e)M.innerText='æœªé€‰æ‹©ä»»ä½•é¡¹ç›®',j.disabled=!0,j.style.background='linear-gradient(135deg, #2E7D32, #1B5E20)',j.style.opacity='0.4',j.style.cursor='not-allowed';else{const t=T?` | å½“å‰: ${T}`:'';M.innerText=h?`å·²é€‰ä¸­ ${e} ä¸ªé¡¹ç›®${t}`:`å·²é€‰æ‹©: ${T}`,j.disabled=!1,j.style.background='linear-gradient(135deg, #43A047, #2E7D32)',j.style.opacity='1',j.style.cursor='pointer'}};n.addEventListener('click',async e=>{const t=e.target.closest('.fate-card');if(!t)return;const a=t.dataset.key||'',n=t.dataset.meta;try{const e=JSON.parse(decodeURIComponent(n||'{}'));h?S.has(a)?S.delete(a):S.add(a):(S.clear(),S.add(a)),T=a,N(),await(async(e,t)=>{P.innerHTML=l(e,t),O.innerText='æ­£åœ¨åŠ è½½å†…å®¹...';try{const t=await fetch(`${d}${e}${g}`,{cache:'no-cache'});O.innerText=t.ok?await t.text():`æ— æ³•åŠ è½½: ${t.status}`}catch(e){O.innerText=`é”™è¯¯: ${e.message}`}})(a,e)}catch(e){console.error(e)}}),j.onclick=async()=>{if(0===S.size)return;const e=Array.from(S);b&&(y(),await b(e,C))},N()})},m=(e,t,a,n)=>{let r=!1;return()=>{r=!r,r?(e.style.flex='0 0 40%',e.style.minWidth='120px',e.style.maxWidth='250px',t.style.display='flex',a.classList.add('fate-sys-mode-split'),n.innerHTML='<i class="fas fa-th"></i>'):(e.style.flex='1',e.style.minWidth='0',e.style.maxWidth='none',t.style.display='none',a.classList.remove('fate-sys-mode-split'),n.innerHTML='<i class="fas fa-th-large"></i>')}},u=async(e,t)=>{toastr.info('åŠ è½½ç›®å½•...','',{timeOut:0});try{const a=await fetch(e,{cache:'no-cache'});if(!a.ok)throw new Error(`ç›®å½•ä¸‹è½½å¤±è´¥: ${a.status}`);const n=await a.json();toastr.clear();const r=Object.keys(n).map(e=>({key:e,...n[e]}));return t&&r.sort(t),{list:r,catalog:n}}catch(e){throw toastr.clear(),toastr.error(`åŠ è½½å¤±è´¥: ${e.message}`),e}},h=e=>{const t=getCharWorldbookNames('current');if(!t)throw new Error('æœªæ‰¾åˆ°ä»»ä½•ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåœ¨é…’é¦†ä¸­åˆ›å»ºä¸–ç•Œä¹¦');if('global'===e){const e=getGlobalWorldbookNames();if(!e||0===e.length)throw new Error('æœªæ‰¾åˆ°ä»»ä½•å…¨å±€ä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåœ¨é…’é¦†ä¸­åˆ›å»ºä¸–ç•Œä¹¦');return{primary:e[0],secondary:e.slice(1)}}if(!t.primary)throw new Error('å½“å‰è§’è‰²å¡æœªç»‘å®šä¸–ç•Œä¹¦ï¼Œè¯·å…ˆåœ¨è§’è‰²å¡è®¾ç½®ä¸­ç»‘å®šä¸€ä¸ªä¸–ç•Œä¹¦');return{primary:t.primary,secondary:t.additional||[]}},v=()=>{let e=document;try{window.top?.document&&(e=window.top.document)}catch(e){}const t=e.getElementById('custom-system-modal');if(!t)return;const a=e.getElementById('sys-updater-settings-overlay');a&&a.remove();const n=e.createElement('div');n.id='sys-updater-settings-overlay',Object.assign(n.style,{position:'absolute',top:'0',left:'0',width:'100%',height:'100%',backgroundColor:'rgba(0,0,0,0.6)',zIndex:'200',display:'flex',justifyContent:'center',alignItems:'center',backdropFilter:'blur(2px)'}),n.onclick=e=>e.stopPropagation();const r=p(),o=e.createElement('div');Object.assign(o.style,{backgroundColor:'#263238',color:'#ECEFF1',padding:'20px',borderRadius:'16px',minWidth:'320px',maxWidth:'90%'});let s='';Object.entries(l).forEach(([e,t])=>{const a=r.bgColor===t.bgColor?'checked':'';s+=`\n        <label style="display:flex; align-items:center; gap:10px; margin:8px 0; cursor:pointer;">\n          <input type="radio" name="theme" value="${e}" ${a}>\n          <span>${t.name}</span>\n        </label>\n      `}),o.innerHTML=`\n      <h3 style="margin-top:0; display:flex; align-items:center; gap:8px;">\n        <i class="fas fa-cog"></i> ç•Œé¢è®¾ç½®\n      </h3>\n      <div style="margin:16px 0;">\n        <label style="display:block; margin-bottom:8px; opacity:0.8;">é€‰æ‹©ä¸»é¢˜</label>\n        ${s}\n      </div>\n      <div style="margin:16px 0;">\n        <label style="display:block; margin-bottom:8px; opacity:0.8;">çª—å£å®½åº¦</label>\n        <input type="range" id="settings-width" min="600" max="1400" value="${r.width}"\n               style="width:100%; accent-color:#4CAF50;">\n        <div style="text-align:right; font-size:0.8em; opacity:0.7;" id="width-display">${r.width}px</div>\n      </div>\n      <div style="margin:16px 0;">\n        <label style="display:block; margin-bottom:8px; opacity:0.8;">çª—å£é«˜åº¦</label>\n        <input type="range" id="settings-height" min="40" max="95" value="${r.height}"\n               style="width:100%; accent-color:#4CAF50;">\n        <div style="text-align:right; font-size:0.8em; opacity:0.7;" id="height-display">${r.height}%</div>\n      </div>\n      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:20px;">\n        <button id="settings-cancel" style="\n          padding:8px 20px; border-radius:20px; border:1px solid rgba(255,255,255,0.3);\n          background:transparent; color:#ECEFF1; cursor:pointer;">å–æ¶ˆ\n        </button>\n        <button id="settings-save" style="\n          padding:8px 20px; border-radius:20px; border:none;\n          background:linear-gradient(135deg, #43A047, #2E7D32); color:white; cursor:pointer;">ä¿å­˜\n        </button>\n      </div>\n    `,n.appendChild(o),t.appendChild(n);const d=o.querySelector('#settings-width'),c=o.querySelector('#settings-height'),y=o.querySelector('#width-display'),f=o.querySelector('#height-display');d.oninput=()=>{y.innerText=d.value+'px'},c.oninput=()=>{f.innerText=c.value+'%'};const g=o.querySelector('#settings-cancel'),m=o.querySelector('#settings-save');g.onclick=()=>n.remove(),m.onclick=()=>{const e=o.querySelector('input[name="theme"]:checked')?.value;if(e&&l[e]){const t=l[e];r.bgColor=t.bgColor,r.cardColor=t.cardColor,r.textColor=t.textColor}var t;r.width=parseInt(d.value),r.height=parseInt(c.value),t=r,localStorage.setItem(i,JSON.stringify(t)),n.remove(),b()}},b=()=>{const e=(window.top?.document||document).querySelector('#custom-system-modal > div.fate-modal-content');e&&(e.querySelector('.system-card')?x('',{fromMain:!0}):e.querySelector('.role-card')?E('',{fromMain:!0}):e.querySelector('.race-card')?A('',{fromMain:!0}):e.querySelector('.module-card')&&F())},x=async(a,n={fromMain:!1})=>{const{fromMain:r=!1}=n;a||await g({title:'å‘½å®šç³»ç»Ÿ Â· é€‰æ‹©é¢æ¿',icon:'fas fa-cubes',searchPlaceholder:'ğŸ” æœç´¢ç³»ç»Ÿåç§°ã€ä½œè€…...',catalogUrl:t,sortFn:(e,t)=>{const a='æœªçŸ¥'===e.updateTime?'1970-01-01':e.updateTime;return('æœªçŸ¥'===t.updateTime?'1970-01-01':t.updateTime).localeCompare(a)},previewUrlBase:e+'/system/',fromMain:r,multiSelect:!1,cardRenderer:(e,t)=>{const{author:a='æœªçŸ¥',updateTime:n='æœªçŸ¥',description:r='æš‚æ— ç®€ä»‹',systemName:o=e.key}=e,s=encodeURIComponent(JSON.stringify({author:a,updateTime:n,description:r,systemName:o}));return`\n            <div class="fate-card system-card" data-search="${`${e.key} ${a} ${n} ${r}`.toLowerCase()}" data-key="${e.key}" data-meta="${s}"\n                 style="background: linear-gradient(145deg, ${t.cardBase}, ${t.cardDark});">\n              <div class="fate-card-title">${e.key}</div>\n              <div class="fate-card-sep"></div>\n              <div class="fate-card-info">\n                <div class="fate-info-row"><span style="opacity:0.7;">ä½œè€…</span><span class="fate-info-value">${a}</span></div>\n                <div class="fate-info-row"><span style="opacity:0.7;">æ›´æ–°</span><span class="fate-info-value">${n}</span></div>\n              </div>\n              <div class="fate-selected-indicator"><i class="fas fa-check-circle"></i></div>\n            </div>\n          `},detailRenderer:(e,t)=>{const a=t.description||'æš‚æ— ç®€ä»‹';return`\n            <div class="fate-detail-item"><span class="fate-detail-label">ç³»ç»Ÿåç§°</span><span class="fate-detail-value">${e}</span></div>\n            <div class="fate-detail-item"><span class="fate-detail-label">ä½œè€…</span><span class="fate-detail-value">${t.author}</span></div>\n            <div class="fate-detail-item"><span class="fate-detail-label">æ›´æ–°æ—¥æœŸ</span><span class="fate-detail-value">${t.updateTime}</span></div>\n            <div class="fate-detail-item" style="border-bottom:none; flex-direction:column; align-items:flex-start;">\n              <div class="fate-detail-label" style="margin-bottom:5px;">ç®€ä»‹</div>\n              <div style="opacity:0.9; line-height:1.4; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px; width:100%;">${a}</div>\n            </div>\n          `},onApply:async(e,t)=>{await k(e[0],t?.[e[0]])}})},w=async(e,t,a,n)=>{await updateWorldbookWith(e,e=>{const r=e.findIndex(e=>(e.name||e.comment||'')===t);if(-1!==r)e[r]={...e[r],content:n,...a,uid:e[r].uid,enabled:!0};else{const t={content:n,...a};'uid'in t&&delete t.uid,e.push(t)}return e})},k=async(a,n)=>{try{if(toastr.info('æ­£åœ¨åŒæ­¥ç³»ç»Ÿé…ç½®...','',{timeOut:0}),!n)try{const e=await fetch(t,{cache:'no-cache'}),r=await e.json();r[a]&&(n=r[a])}catch(e){}const r=await fetch(`${e}/system/${a}.txt`,{cache:'no-cache'});if(!r.ok)throw new Error(`æ— æ³•è·å–ç³»ç»Ÿå†…å®¹ (${r.status})`);const o=await r.text(),i={wb:{success:!1,msg:''}},l=h('current'),d=`å‘½å®šç³»ç»Ÿ-${a}${s}(${n?.author||'æœªçŸ¥'})`,c={name:d,comment:d,enabled:!0,strategy:{type:'constant'},position:{type:'at_depth',depth:1,order:1100},recursion:{prevent_outgoing:!0}};await w(l.primary,d,c,o),i.wb={success:!0,msg:'æ›´æ–°å®Œæˆ'},toastr.clear();const p=i.wb.success?'success':'error',y=`ç³»ç»Ÿ: ${a}\nä¸–ç•Œä¹¦: ${i.wb.msg}`;toastr[p](y,'åŒæ­¥ç»“æŸ',{timeOut:5e3})}catch(e){toastr.error(e.message,'è„šæœ¬é”™è¯¯')}},C=async(e,t,a)=>{const{author:r='æœªçŸ¥',description:o='æš‚æ— ç®€ä»‹',keywords:i=[],keywords_secondary:l=[]}=t,d=Array.isArray(i)?i:i?[String(i)]:[],c=Array.isArray(l)?l:l?[String(l)]:[],p=((e,t,a)=>{const n=a.replace(/\s+/g,' ').trim(),r=n.length>50?n.substring(0,50)+'â€¦':n;return`[è§’è‰²]${e}${s}(${t}-${r})`})(e,r,o),y=await fetch(`${n}${e}.txt`,{cache:'no-cache'});if(!y.ok)throw new Error(`æ— æ³•è·å–è§’è‰²å†…å®¹ (${y.status})`);const f=await y.text(),g={name:p,enabled:!0,use_group_scoring:!1,strategy:{type:'selective',keys:d,keys_secondary:{logic:'and_any',keys:c}},position:{type:'after_character_definition',order:601},recursion:{prevent_incoming:!0,prevent_outgoing:!0}};await w(a,p,g,f)},E=async(e,t={fromMain:!1})=>{const{fromMain:r=!1}=t;e||await g({title:'å‘½å®šè§’è‰² Â· é€‰æ‹©é¢æ¿',icon:'fas fa-users',searchPlaceholder:'ğŸ” æœç´¢è§’è‰²ã€ä½œè€…...',catalogUrl:a,sortFn:(e,t)=>{const a='æœªçŸ¥'===e.updateTime?'1970-01-01':e.updateTime;return('æœªçŸ¥'===t.updateTime?'1970-01-01':t.updateTime).localeCompare(a)},previewUrlBase:n,fromMain:r,multiSelect:!0,catalogProcessor:e=>{Object.keys(e).forEach(t=>{const a=e[t];'string'==typeof a.keywords&&(a.keywords=a.keywords.split(',').map(e=>e.trim()).filter(Boolean)),Array.isArray(a.keywords)||(a.keywords=[]),'string'==typeof a.keywords_secondary&&(a.keywords_secondary=a.keywords_secondary.split(',').map(e=>e.trim()).filter(Boolean)),Array.isArray(a.keywords_secondary)||(a.keywords_secondary=[])})},cardRenderer:(e,t)=>{const{author:a='æœªçŸ¥',updateTime:n='æœªçŸ¥',description:r='æš‚æ— ç®€ä»‹',keywords:o=[],keywords_secondary:s=[]}=e,i=encodeURIComponent(JSON.stringify({author:a,updateTime:n,description:r,keywords:o,keywordsSecondary:s}));return`\n            <div class="fate-card role-card" data-search="${`${e.key} ${a} ${n} ${r}`.toLowerCase()}" data-key="${e.key}" data-meta="${i}"\n                 style="background: linear-gradient(145deg, ${t.cardBase}, ${t.cardDark});">\n              <div class="fate-card-title">${e.key}</div>\n              <div class="fate-card-sep"></div>\n              <div class="fate-card-info">\n                <div class="fate-info-row"><span style="opacity:0.7;">ä½œè€…</span><span class="fate-info-value">${a}</span></div>\n                <div class="fate-info-row"><span style="opacity:0.7;">æ›´æ–°</span><span class="fate-info-value">${n}</span></div>\n              </div>\n              <div class="fate-selected-indicator"><i class="fas fa-check-circle"></i></div>\n            </div>\n          `},detailRenderer:(e,t)=>{let a='';t.keywords?.length&&(a+=`<div class="fate-detail-item"><span class="fate-detail-label">ä¸»è¦å…³é”®è¯</span><span class="fate-detail-value">${t.keywords.join(', ')}</span></div>`),t.keywordsSecondary?.length&&(a+=`<div class="fate-detail-item"><span class="fate-detail-label">æ¬¡è¦å…³é”®è¯</span><span class="fate-detail-value">${t.keywordsSecondary.join(', ')}</span></div>`);const n=t.description||'æš‚æ— ç®€ä»‹';return`\n            <div class="fate-detail-item"><span class="fate-detail-label">è§’è‰²åç§°</span><span class="fate-detail-value">${e}</span></div>\n            <div class="fate-detail-item"><span class="fate-detail-label">ä½œè€…</span><span class="fate-detail-value">${t.author}</span></div>\n            <div class="fate-detail-item"><span class="fate-detail-label">æ›´æ–°æ—¥æœŸ</span><span class="fate-detail-value">${t.updateTime}</span></div>\n            ${a}\n            <div class="fate-detail-item" style="border-bottom:none; flex-direction:column; align-items:flex-start;">\n              <div class="fate-detail-label" style="margin-bottom:5px;">ç®€ä»‹</div>\n              <div style="opacity:0.9; line-height:1.4; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px; width:100%;">${n}</div>\n            </div>\n          `},onApply:async(e,t)=>{try{toastr.info(`æ­£åœ¨åŒæ­¥ ${e.length} ä¸ªè§’è‰²...`,'',{timeOut:0});const a=await(async(e,t)=>{const a=h('current').primary;let n=0,r=0;const o=[];return await Promise.allSettled(e.map(async e=>{try{const r=t[e];if(!r)throw new Error('è§’è‰²ä¿¡æ¯ç¼ºå¤±');await C(e,r,a),n++}catch(t){r++,o.push(`${e}: ${t.message}`)}})),{successCount:n,failCount:r,errors:o}})(e,t);toastr.clear(),a.errors.length>0?toastr.warning(`åŒæ­¥å®Œæˆ: æˆåŠŸ ${a.successCount}, å¤±è´¥ ${a.failCount}\né”™è¯¯è¯¦æƒ…: ${a.errors.join('; ')}`,'è§’è‰²åŒæ­¥',{timeOut:8e3}):toastr.success(`æˆåŠŸåŒæ­¥ ${a.successCount} ä¸ªè§’è‰²æ¡ç›®`,'è§’è‰²åŒæ­¥å®Œæˆ')}catch(e){toastr.error(`åŒæ­¥å¤±è´¥: ${e.message}`)}}})},B=async(e,t,a,n)=>{const{author:r='æœªçŸ¥',description:i='æš‚æ— ç®€ä»‹',keywords:l=[]}=t,d=Array.isArray(l)?l:l?[String(l)]:[],c=((e,t,a)=>{const n=a.replace(/\s+/g,' ').trim(),r=n.length>50?n.substring(0,50)+'â€¦':n;return`[æ‰©å±•][${e}]ç§æ—-${e}${s}(${t}-${r})`})(e,r,i),p=await fetch(`${o}${e}.txt`,{cache:'no-cache'});if(!p.ok)throw new Error(`æ— æ³•è·å–ç§æ—å†…å®¹ (${p.status})`);let y=await p.text();n&&(y=y.replace(/\s*$/,''),y+=`\n{{setvar::${e}::${n}}}`);const f={name:c,enabled:!0,use_group_scoring:!1,strategy:{type:'selective',keys:d},position:{type:'before_character_definition',order:14},recursion:{prevent_incoming:!0,prevent_outgoing:!0}};await w(a,c,f,y)},I=async(e,t)=>{const a=h('current').primary;let n=0,r=0;const o=[],s=[];if(await Promise.allSettled(e.map(async e=>{try{const r=t[e];if(!r)throw new Error('ç§æ—ä¿¡æ¯ç¼ºå¤±');await B(e,r,a),s.push({key:e}),n++}catch(t){r++,o.push(`${e}: ${t.message}`)}})),s.length>0)try{await(async(e,t)=>{await updateWorldbookWith(e,e=>{const a=e.find(e=>'ç§æ—æ¦‚è§ˆ'===e.name);if(a){let e=a.content||'';const n=e.split('\n'),r=new Set;n.forEach(e=>{const t=e.match(/\{\{getvar::([^}]+)\}\}/);t&&r.add(t[1])});let o=!1;t.forEach(({key:t})=>{r.has(t)||(e+=`\n{{getvar::${t}}}`,o=!0)}),o&&(a.content=e)}return e})})(a,s)}catch(e){console.error('æ›´æ–°ç§æ—æ¦‚è§ˆå¤±è´¥:',e)}return{successCount:n,failCount:r,errors:o}},A=async(e,t={fromMain:!1})=>{const{fromMain:a=!1}=t;e||await g({title:'å‘½å®šç§æ— Â· é€‰æ‹©é¢æ¿',icon:'fas fa-dragon',searchPlaceholder:'ğŸ” æœç´¢ç§æ—ã€ä½œè€…...',catalogUrl:r,sortFn:(e,t)=>{const a='æœªçŸ¥'===e.updateTime?'1970-01-01':e.updateTime;return('æœªçŸ¥'===t.updateTime?'1970-01-01':t.updateTime).localeCompare(a)},previewUrlBase:o,fromMain:a,multiSelect:!0,catalogProcessor:e=>{Object.keys(e).forEach(t=>{const a=e[t];'string'==typeof a.keywords&&(a.keywords=a.keywords.split(',').map(e=>e.trim()).filter(Boolean)),Array.isArray(a.keywords)||(a.keywords=[])})},cardRenderer:(e,t)=>{const{author:a='æœªçŸ¥',updateTime:n='æœªçŸ¥',description:r='æš‚æ— ç®€ä»‹',keywords:o=[]}=e,s=encodeURIComponent(JSON.stringify({author:a,updateTime:n,description:r,keywords:o}));return`\n            <div class="fate-card race-card" data-search="${`${e.key} ${a} ${n} ${r}`.toLowerCase()}" data-key="${e.key}" data-meta="${s}"\n                 style="background: linear-gradient(145deg, ${t.cardBase}, ${t.cardDark});">\n              <div class="fate-card-title">${e.key}</div>\n              <div class="fate-card-sep"></div>\n              <div class="fate-card-info">\n                <div class="fate-info-row"><span style="opacity:0.7;">ä½œè€…</span><span class="fate-info-value">${a}</span></div>\n                <div class="fate-info-row"><span style="opacity:0.7;">æ›´æ–°</span><span class="fate-info-value">${n}</span></div>\n              </div>\n              <div class="fate-selected-indicator"><i class="fas fa-check-circle"></i></div>\n            </div>\n          `},detailRenderer:(e,t)=>{let a='';t.keywords?.length&&(a+=`<div class="fate-detail-item"><span class="fate-detail-label">å…³é”®è¯</span><span class="fate-detail-value">${t.keywords.join(', ')}</span></div>`);const n=t.description||'æš‚æ— ç®€ä»‹';return`\n            <div class="fate-detail-item"><span class="fate-detail-label">ç§æ—åç§°</span><span class="fate-detail-value">${e}</span></div>\n            <div class="fate-detail-item"><span class="fate-detail-label">ä½œè€…</span><span class="fate-detail-value">${t.author}</span></div>\n            <div class="fate-detail-item"><span class="fate-detail-label">æ›´æ–°æ—¥æœŸ</span><span class="fate-detail-value">${t.updateTime}</span></div>\n            ${a}\n            <div class="fate-detail-item" style="border-bottom:none; flex-direction:column; align-items:flex-start;">\n              <div class="fate-detail-label" style="margin-bottom:5px;">ç®€ä»‹</div>\n              <div style="opacity:0.9; line-height:1.4; background:rgba(0,0,0,0.2); padding:8px; border-radius:4px; width:100%;">${n}</div>\n            </div>\n          `},onApply:async(e,t)=>{try{toastr.info(`æ­£åœ¨åŒæ­¥ ${e.length} ä¸ªç§æ—...`,'',{timeOut:0});const a=await I(e,t);toastr.clear(),a.errors.length>0?toastr.warning(`åŒæ­¥å®Œæˆ: æˆåŠŸ ${a.successCount}, å¤±è´¥ ${a.failCount}\né”™è¯¯è¯¦æƒ…: ${a.errors.join('; ')}`,'ç§æ—åŒæ­¥',{timeOut:8e3}):toastr.success(`æˆåŠŸåŒæ­¥ ${a.successCount} ä¸ªç§æ—æ¡ç›®`,'ç§æ—åŒæ­¥å®Œæˆ')}catch(e){toastr.error(`åŒæ­¥å¤±è´¥: ${e.message}`)}}})},S=[{id:'system',name:'ç³»ç»Ÿ',desc:'åŒæ­¥å‘½å®šç³»ç»Ÿé…ç½®ï¼ˆä¸–ç•Œä¹¦ï¼‰',color:'#1565C0',action:()=>x('',{fromMain:!0})},{id:'character',name:'è§’è‰²',desc:'æ‰¹é‡éƒ¨ç½²è§’è‰²ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå¤šé€‰ï¼‰',color:'#2E7D32',action:()=>E('',{fromMain:!0})},{id:'race',name:'ç§æ—',desc:'æ‰¹é‡éƒ¨ç½²ç§æ—ä¸–ç•Œä¹¦æ¡ç›®ï¼ˆå¤šé€‰ï¼‰',color:'#7B1FA2',action:()=>A('',{fromMain:!0})}],F=()=>{p();let e='';S.forEach(t=>{e+=`\n        <div class="module-card" data-module="${t.id}" style="cursor:pointer; padding:20px; background:linear-gradient(145deg, ${t.color}, ${c(t.color,-20)});\n                border:1px solid rgba(255,255,255,0.2); border-radius:24px; display:flex; flex-direction:column;\n                box-shadow:0 8px 16px rgba(0,0,0,0.3); transition: all 0.2s ease; color:#fff;">\n          <div style="font-size:1.4em; font-weight:600; margin-bottom:12px;"><i class="fas fa-${'system'===t.id?'cubes':'character'===t.id?'user-tie':'dragon'}"></i> ${t.name}</div>\n          <div style="font-size:0.9em; opacity:0.9; line-height:1.5;">${t.desc}</div>\n        </div>\n      `});f(`\n      <div class="fate-header">\n        <h3><i class="fas fa-tools" style="margin-right:10px;"></i>å‘½å®šåˆ›æ„å·¥åŠ Â· ä¸»èœå•</h3>\n        <div style="display:flex; gap:8px;">\n          <button class="fate-icon-btn" id="main-settings-btn" title="ç•Œé¢è®¾ç½®"><i class="fas fa-cog"></i></button>\n        </div>\n      </div>\n      <div style="flex:1; display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:20px; align-content:start; padding:20px; overflow-y:auto;">\n        ${e}\n      </div>\n    `,(e,t)=>{const a=e.getElementById('main-settings-btn');a&&(a.onclick=e=>{e.stopPropagation(),v()}),e.querySelectorAll('.module-card').forEach(e=>{e.onclick=()=>{const t=e.getAttribute('data-module'),a=S.find(e=>e.id===t);a&&(y(),a.action())}})})};replaceScriptButtons([{name:'å‘½å®šåˆ›æ„å·¥åŠ',visible:!0}]),eventOn(getButtonEvent('å‘½å®šåˆ›æ„å·¥åŠ'),()=>{F()}),console.info('åˆ›æ„å·¥åŠè„šæœ¬å·²åŠ è½½')});
//# sourceMappingURL=index.js.map